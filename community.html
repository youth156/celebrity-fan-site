<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="community-page-title">粉丝社区 - BoomRaveewit</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 引入Mapbox GL JS用于地图功能 -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <!-- 引入社区功能增强模块 -->
    <script src="community-features.js" defer></script>
    <!-- 引入星光地图功能模块 -->
    <!-- 移除重复的模块引入 -->
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script src="./tailwind-fix.js"></script>
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
            .transition-custom {
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            .backdrop-blur-sm {
                backdrop-filter: blur(4px);
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            /* 防止内容被底部导航遮挡 */
            .content-safe-bottom {
                padding-bottom: env(safe-area-inset-bottom, 80px);
            }
            /* 平滑滚动 */
            .smooth-scroll {
                scroll-behavior: smooth;
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px -8px rgba(108, 56, 255, 0.15);
            }
            
            /* 卡片基础样式 */
            .card {
                transition: all 0.3s ease;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            
            .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 24px -8px rgba(108, 56, 255, 0.15);
            }
            
            /* 消息卡片样式优化 */
            .message-card {
                background: white;
                border-radius: 16px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .message-card:hover {
                box-shadow: 0 8px 16px -8px rgba(108, 56, 255, 0.15);
            }
            .tab-active {
                position: relative;
            }
            .tab-active::after {
                content: '';
                position: absolute;
                bottom: -1px;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 3px;
                background-color: #6C38FF;
                border-radius: 3px;
                transition: all 0.3s ease;
            }
        }
    </style>
    <!-- 预加载字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* 地图自定义样式 */
        .mapboxgl-popup-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .mapboxgl-popup-close-button {
            font-size: 20px;
            color: #666;
        }
        .message-card {
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .message-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -8px rgba(108, 56, 255, 0.15);
            border-color: rgba(108, 56, 255, 0.1);
        }
        /* 星空效果 */
        .star-animation {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        /* 模态框动画 */
        .modal-enter {
            animation: modalFadeIn 0.3s ease-out;
        }
        .modal-backdrop-enter {
            animation: backdropFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes backdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* 加载动画 */
        .loader {
            border-top-color: #6C38FF;
            animation: spinner 0.8s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-light to-gray-100 font-sans text-gray-800 min-h-screen">
    <!-- 导航栏 -->
    <header id="navbar" class="fixed w-full z-50 transition-all duration-300 bg-white/95 backdrop-blur-sm shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                        <i class="fa fa-star text-white text-xl"></i>
                    </div>
                    <span class="text-2xl font-display font-bold text-dark">BoomRaveewit</span>
                </a>
                
                <!-- 桌面导航 -->
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="index.html#home" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="home">首页</a>
                    <a href="index.html#about" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="about">关于</a>
                    <a href="index.html#works" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="works">作品</a>
                    <a href="index.html#gallery" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="gallery">照片</a>
                    <a href="index.html#news" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="news">动态</a>
                    <a href="community.html" class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-full font-medium transition-custom transform hover:scale-105" data-lang-key="community">粉丝社区</a>
                      
                    <!-- 语言切换下拉菜单 -->
                    <div id="language-selector" class="relative ml-6">
                        <button id="language-btn" class="flex items-center space-x-2 bg-gray-100 hover:bg-primary text-gray-800 hover:text-white px-3 py-1.5 rounded-full transition-custom">
                            <i class="fa fa-globe"></i>
                            <span id="current-language">中文</span>
                            <i class="fa fa-chevron-down text-xs"></i>
                        </button>
                        <div id="language-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl overflow-hidden z-10 hidden">
                            <a href="#" data-lang="zh" class="block px-4 py-2 hover:bg-primary/10 text-gray-800 transition-custom">
                                <span class="flag-icon">🇨🇳</span> 中文
                            </a>
                            <a href="#" data-lang="en" class="block px-4 py-2 hover:bg-primary/10 text-gray-800 transition-custom">
                                <span class="flag-icon">🇬🇧</span> English
                            </a>
                            <a href="#" data-lang="th" class="block px-4 py-2 hover:bg-primary/10 text-gray-800 transition-custom">
                                <span class="flag-icon">🇹🇭</span> ภาษาไทย
                            </a>
                        </div>
                    </div>
                </nav>
                
                <!-- 移动端菜单按钮 -->
                <button id="menu-toggle" class="md:hidden text-dark text-2xl focus:outline-none">
                    <i class="fa fa-bars"></i>
                </button>
            </div>            
        </div>
        
        <!-- 移动端导航菜单 -->
        <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-gray-200">
            <div class="container mx-auto px-4 py-4 space-y-4">
                <a href="index.html#home" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="home">首页</a>
                <a href="index.html#about" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="about">关于</a>
                <a href="index.html#works" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="works">作品</a>
                <a href="index.html#gallery" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="gallery">照片</a>
                <a href="index.html#news" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="news">动态</a>
                <a href="community.html" class="block bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg font-medium transition-custom text-center mt-2" data-lang-key="community">粉丝社区</a>
                
                <!-- 移动端语言切换 -->
                <div class="pt-2 border-t border-gray-200">
                    <button id="mobile-lang-btn" class="flex items-center justify-between w-full text-dark py-2">
                        <span><i class="fa fa-globe mr-2"></i> <span data-lang-key="language">语言</span></span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </button>
                    <div id="mobile-lang-menu" class="hidden mt-2 space-y-1">
                        <a href="#" data-lang="zh" class="block px-4 py-2 hover:bg-primary/10 text-dark transition-custom">
                            <span class="flag-icon">🇨🇳</span> 中文
                        </a>
                        <a href="#" data-lang="en" class="block px-4 py-2 hover:bg-primary/10 text-dark transition-custom">
                            <span class="flag-icon">🇬🇧</span> English
                        </a>
                        <a href="#" data-lang="th" class="block px-4 py-2 hover:bg-primary/10 text-dark transition-custom">
                            <span class="flag-icon">🇹🇭</span> ภาษาไทย
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 页面内容 -->
    <main class="pt-24 pb-24 lg:pb-20">
        <div class="container mx-auto px-4">
            <!-- 移动端底部导航 -->
            <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 lg:hidden z-40">
                <div class="flex justify-around items-center h-16 overflow-hidden">
                    <!-- 调整每个导航项的样式以适应五个选项 -->
                    <style scoped>
                        .fixed.bottom-0 nav a {
                            flex: 1;
                            max-width: 20%;
                        }
                    </style>
                    <a href="#" class="flex flex-col items-center justify-center text-primary" data-tab="messages">
                        <i class="fa fa-comments text-xl"></i>
                        <span class="text-xs mt-1" data-lang-key="message-wall">留言</span>
                    </a>
                    <a href="#" class="flex flex-col items-center justify-center text-gray-500" data-tab="map">
                        <i class="fa fa-map-marker text-xl"></i>
                        <span class="text-xs mt-1" data-lang-key="star-map">地图</span>
                    </a>
                    <a href="#" class="flex flex-col items-center justify-center text-gray-500">
                        <i class="fa fa-bell text-xl"></i>
                        <span class="text-xs mt-1">通知</span>
                    </a>
                    <a href="#" class="flex flex-col items-center justify-center text-gray-500">
                        <i class="fa fa-user text-xl"></i>
                        <span class="text-xs mt-1">我的</span>
                    </a>
                    <a href="https://youth156.github.io/pingtu/" target="_blank" class="flex flex-col items-center justify-center text-gray-500 hover:text-primary transition-colors">
                        <i class="fa fa-puzzle-piece text-xl"></i>
                        <span class="text-xs mt-1">拼图</span>
                    </a>
                </div>
            </nav>

            <!-- 三栏布局容器 -->
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 左侧边栏：用户信息和导航 -->
                <aside class="w-full lg:w-64 shrink-0">
                    <!-- 用户信息卡片 -->
                    <div class="bg-gradient-to-br from-primary/95 to-secondary/95 rounded-2xl p-6 shadow-xl text-white relative overflow-hidden transform transition-all duration-500 hover:shadow-2xl mb-6">
                        <!-- 装饰星星效果 -->
                        <div id="stars-container"></div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center mb-4">
                                <div class="w-20 h-20 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center mr-4 transition-transform duration-300 hover:scale-105">
                                    <i class="fa fa-user-circle text-4xl text-white"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-shadow" id="welcome-message"><span id="username-display" class="text-primary"></span> <span data-lang-key="welcome">欢迎回来</span></h2>
                                </div>
                            </div>
                            <p class="text-white/90 text-sm mb-4" data-lang-key="community-subtitle">加入Boom的粉丝社区，与全球粉丝互动</p>
                            <button id="logout-btn" class="w-full bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-5 py-2 rounded-full font-medium transition-custom flex items-center justify-center transform hover:scale-105">
                                <i class="fa fa-sign-out mr-2"></i>
                                <span data-lang-key="logout">退出登录</span>
                            </button>
                        </div>
                    </div>

                    <!-- 社区导航 -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6 card">
                        <h3 class="font-semibold text-gray-700 mb-3 px-2">社区导航</h3>
                        <div class="space-y-1">
                            <button id="sidebar-message-tab" class="w-full flex items-center px-4 py-3 rounded-lg text-primary bg-primary/5 font-medium">
                                <i class="fa fa-comments mr-3 w-5 text-center"></i>
                                <span data-lang-key="message-wall">粉丝留言墙</span>
                            </button>
                            <button id="sidebar-map-tab" class="w-full flex items-center px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium">
                                <i class="fa fa-map-marker mr-3 w-5 text-center"></i>
                                <span data-lang-key="star-map">星光地图</span>
                            </button>
                            <button class="w-full flex items-center px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium">
                                <i class="fa fa-calendar mr-3 w-5 text-center"></i>
                                <span>活动日历</span>
                            </button>
                            <button class="w-full flex items-center px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium">
                                <i class="fa fa-trophy mr-3 w-5 text-center"></i>
                                <span>粉丝成就</span>
                            </button>
                            <a href="https://youth156.github.io/pingtu/" target="_blank" class="w-full flex items-center px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition-colors hover:text-primary">
                        <i class="fa fa-puzzle-piece mr-3 w-5 text-center"></i>
                        <span>梦幻拼图游戏</span>
                    </a>
                        </div>
                    </div>

                    <!-- 快速统计 -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 card">
                        <h3 class="font-semibold text-gray-700 mb-3 px-2">社区统计</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <i class="fa fa-users text-primary mr-2"></i>
                                    <span class="text-sm text-gray-600" data-lang-key="total-fans">总粉丝数</span>
                                </div>
                                <span class="font-bold text-primary" id="sidebar-total-fans">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <i class="fa fa-map-marker text-secondary mr-2"></i>
                                    <span class="text-sm text-gray-600" data-lang-key="total-markers">地图标记</span>
                                </div>
                                <span class="font-bold text-secondary" id="sidebar-total-markers">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <i class="fa fa-comments text-green-500 mr-2"></i>
                                    <span class="text-sm text-gray-600">今日留言</span>
                                </div>
                                <span class="font-bold text-green-500">0</span>
                            </div>
                        </div>
                    </div>
                </aside>
                
                <!-- 主内容区域 -->
                <main class="flex-1">
                    <!-- 导航标签（桌面端） -->
                    <div class="bg-white rounded-xl shadow-sm p-1 mb-6 lg:hidden animate-slide-up">
                        <div class="flex rounded-lg overflow-hidden">
                            <button id="mobile-message-tab" class="flex-1 py-3 px-6 font-medium text-primary bg-primary/5 rounded-lg transition-custom tab-active" data-tab="messages">
                                <i class="fa fa-comments mr-2"></i>
                                <span data-lang-key="message-wall">粉丝留言墙</span>
                            </button>
                            <button id="mobile-map-tab" class="flex-1 py-3 px-6 font-medium text-gray-600 hover:text-primary hover:bg-primary/5 rounded-lg transition-custom" data-tab="map">
                                <i class="fa fa-map-marker mr-2"></i>
                                <span data-lang-key="star-map">星光地图</span>
                            </button>
                        </div>
                    </div>

                    <!-- 粉丝留言墙 -->
                    <div id="messages-content" class="space-y-6 animate-fade-in">
                        <!-- 发布留言区域 -->
                        <div class="bg-white rounded-2xl shadow-md p-6 card">
                            <div class="flex items-start">
                                <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mr-4 flex-shrink-0">
                                    <i class="fa fa-user text-primary text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <textarea id="message-input" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-custom resize-none" placeholder="分享你的想法..." data-lang-key="share-thoughts"></textarea>
                                    <div class="flex flex-wrap justify-between items-center gap-4 mt-4">
                                        <div class="flex space-x-4">
                                            <button class="text-gray-500 hover:text-primary transition-custom p-2 rounded-full hover:bg-primary/5" id="add-image-btn">
                                                <i class="fa fa-image text-xl"></i>
                                                <input type="file" id="image-upload" accept="image/*" class="hidden">
                                            </button>
                                            <button class="text-gray-500 hover:text-primary transition-custom p-2 rounded-full hover:bg-primary/5">
                                                <i class="fa fa-smile-o text-xl"></i>
                                            </button>
                                        </div>
                                        <button id="post-message-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-full font-medium transition-custom transform hover:scale-105 shadow-lg shadow-primary/20">
                                            <span data-lang-key="post-message">发布留言</span>
                                        </button>
                                    </div>
                                    <div id="image-preview-container" class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2 hidden">
                                        <!-- 图片预览将在这里动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 留言排序和过滤 -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="bg-white rounded-xl shadow-sm p-2 flex">
                                <button class="px-4 py-2 rounded-lg text-primary bg-primary/5 font-medium" data-sort="latest">
                                    <span data-lang-key="latest">最新</span>
                                </button>
                                <button class="px-4 py-2 rounded-lg text-gray-600 hover:text-primary hover:bg-primary/5 font-medium" data-sort="popular">
                                    <span data-lang-key="popular">热门</span>
                                </button>
                                <button class="px-4 py-2 rounded-lg text-gray-600 hover:text-primary hover:bg-primary/5 font-medium" data-sort="mostComments">
                                    <span>最多评论</span>
                                </button>
                            </div>
                            <div class="relative">
                                <input type="text" id="message-search" placeholder="搜索留言..." class="pl-10 pr-4 py-2 rounded-full border border-gray-200 focus:ring-2 focus:ring-primary focus:border-transparent w-full sm:w-auto">
                                <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>

                        <!-- 留言列表 -->
                        <div id="messages-list" class="space-y-6">
                            <!-- 留言将在这里动态生成 -->
                            <!-- 初始加载状态 -->
                            <div id="messages-loading" class="text-center py-12 bg-gray-50 rounded-2xl hidden">
                                <div class="inline-block w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full loader"></div>
                                <p class="text-gray-500 mt-4" data-lang-key="loading">加载中...</p>
                            </div>
                        </div>
                    </div>

                    <!-- 星光地图 -->
                    <div id="map-content" class="hidden animate-fade-in space-y-6">
                        <div class="bg-white rounded-2xl shadow-md p-6 card">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                <h3 class="text-xl font-bold flex items-center" data-lang-key="star-map-description">
                                    <i class="fa fa-globe text-primary mr-2"></i> 在地图上标记你的位置，与全球粉丝连接
                                </h3>
                                <button id="add-marker-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-full font-medium transition-custom transform hover:scale-105 shadow-lg shadow-primary/20">
                                    <i class="fa fa-plus mr-2"></i>
                                    <span data-lang-key="add-marker">添加标记</span>
                                </button>
                            </div>
                            
                            <!-- 粉丝统计 -->
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-xl p-4 text-center transition-all duration-300 hover:shadow-md hover:bg-primary/5">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-primary/10 rounded-full flex items-center justify-center">
                                        <i class="fa fa-users text-primary text-xl"></i>
                                    </div>
                                    <p class="text-3xl font-bold text-primary" id="total-fans">0</p>
                                    <p class="text-gray-500" data-lang-key="total-fans">总粉丝数</p>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 text-center transition-all duration-300 hover:shadow-md hover:bg-secondary/5">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-secondary/10 rounded-full flex items-center justify-center">
                                        <i class="fa fa-map-marker text-secondary text-xl"></i>
                                    </div>
                                    <p class="text-3xl font-bold text-secondary" id="total-markers">0</p>
                                    <p class="text-gray-500" data-lang-key="total-markers">地图标记</p>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 text-center transition-all duration-300 hover:shadow-md hover:bg-green-500/5">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-green-500/10 rounded-full flex items-center justify-center">
                                        <i class="fa fa-building text-green-500 text-xl"></i>
                                    </div>
                                    <p class="text-3xl font-bold text-green-500" id="total-cities">0</p>
                                    <p class="text-gray-500" data-lang-key="total-cities">覆盖城市</p>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 text-center transition-all duration-300 hover:shadow-md hover:bg-blue-500/5">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-blue-500/10 rounded-full flex items-center justify-center">
                                        <i class="fa fa-flag text-blue-500 text-xl"></i>
                                    </div>
                                    <p class="text-3xl font-bold text-blue-500" id="total-countries">0</p>
                                    <p class="text-gray-500" data-lang-key="total-countries">覆盖国家</p>
                                </div>
                            </div>
                        </div>

                        <!-- 地图容器 -->
                        <div class="bg-white rounded-2xl shadow-md overflow-hidden card relative transition-all duration-500 hover:shadow-xl">
                            <div id="map" class="w-full h-[60vh] min-h-[500px]"></div>
                            <!-- 地图加载状态 -->
                            <div id="map-loading" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden transition-opacity duration-500">
                                <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
                                <p class="text-gray-600 mt-4 text-lg" data-lang-key="loading">地图加载中...</p>
                                <p class="text-gray-400 text-sm mt-2">连接全球粉丝，点亮明星梦想</p>
                            </div>
                            
                            <!-- 地图操作按钮 -->
                            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm rounded-full px-4 py-2 shadow-lg flex gap-4 z-5 transition-all duration-300 hover:bg-white">
                                <button id="add-marker-btn" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-full hover:bg-primary/90 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                    <i class="fa fa-plus"></i>
                                    <span>添加标记</span>
                                </button>
                                <button id="my-location-btn" class="flex items-center gap-1 px-3 py-2 bg-white text-gray-700 border border-gray-200 rounded-full hover:bg-gray-50 transition-all duration-300 shadow-sm transform hover:-translate-y-0.5">
                                    <i class="fa fa-location-arrow"></i>
                                    <span>我的位置</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </main>
                
                <!-- 右侧边栏 -->
                <aside class="w-full lg:w-72 shrink-0 hidden lg:block">
                    <!-- 热门话题 -->
                    <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 card">
                        <h3 class="text-lg font-bold mb-4 flex items-center" data-lang-key="hot-topics">
                            <i class="fa fa-fire text-secondary mr-2"></i> 热门话题
                        </h3>
                        <div class="space-y-3">
                            <a href="#" class="block p-3 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-custom">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">#Boom新剧</span>
                                    <span class="text-xs bg-white px-2 py-1 rounded-full">1,283 讨论</span>
                                </div>
                                <p class="text-xs text-primary/80 mt-1">最新更新: 2分钟前</p>
                            </a>
                            <a href="#" class="block p-3 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 transition-custom">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">#粉丝见面会</span>
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">856 讨论</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">最新更新: 15分钟前</p>
                            </a>
                            <a href="#" class="block p-3 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 transition-custom">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">#生日祝福</span>
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">624 讨论</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">最新更新: 32分钟前</p>
                            </a>
                        </div>
                        <button class="w-full mt-4 py-2 text-primary text-sm hover:text-primary/80 transition-custom">
                            <span data-lang-key="view-all">查看全部</span> <i class="fa fa-chevron-right ml-1 text-xs"></i>
                        </button>
                    </div>

                    <!-- 公告栏 -->
                    <div class="bg-gradient-to-br from-blue-500/90 to-purple-500/90 rounded-2xl shadow-sm p-5 mb-6 text-white">
                        <h3 class="text-lg font-bold mb-3 flex items-center">
                            <i class="fa fa-bullhorn mr-2"></i> 社区公告
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg">
                                <h4 class="font-medium">粉丝见面会安排</h4>
                                <p class="text-sm text-white/80 mt-1">3月15日，北京国家会议中心，快来报名参加！</p>
                                <span class="inline-block mt-2 text-xs bg-white/20 px-2 py-0.5 rounded-full">重要</span>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg">
                                <h4 class="font-medium">社区规则更新</h4>
                                <p class="text-sm text-white/80 mt-1">新的社区行为规范已生效，请查看详情。</p>
                                <span class="inline-block mt-2 text-xs bg-white/20 px-2 py-0.5 rounded-full">最新</span>
                            </div>
                        </div>
                    </div>

                    <!-- 在线粉丝 -->
                    <div class="bg-white rounded-2xl shadow-sm p-5 card">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fa fa-circle text-green-500 mr-2 text-xs"></i> 在线粉丝 (24)
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                                        <i class="fa fa-user text-primary"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">BoomOfficial</p>
                                        <p class="text-xs text-gray-500">官方账号</p>
                                    </div>
                                </div>
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                        <i class="fa fa-user text-gray-400"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">超级粉丝</p>
                                        <p class="text-xs text-gray-500">在线32分钟</p>
                                    </div>
                                </div>
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                        <i class="fa fa-user text-gray-400"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">星光守护者</p>
                                        <p class="text-xs text-gray-500">在线15分钟</p>
                                    </div>
                                </div>
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            </div>
                        </div>
                        <button class="w-full mt-4 py-2 text-primary text-sm hover:text-primary/80 transition-custom">
                            <span data-lang-key="view-all">查看全部</span> <i class="fa fa-chevron-right ml-1 text-xs"></i>
                        </button>
                    </div>
                </aside>
            </div>
        </div>
    </main>
        </div>
    </main>

    <!-- 添加标记模态框 -->
    <div id="add-marker-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto shadow-2xl transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold flex items-center" data-lang-key="add-your-marker">
                    <i class="fa fa-map-marker-alt text-primary mr-2"></i>
                    添加你的标记
                </h3>
                <button id="close-marker-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="marker-city" class="block text-gray-700 font-medium mb-1" data-lang-key="city">城市</label>
                        <input type="text" id="marker-city" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300" placeholder="输入你的城市">
                    </div>
                    <div>
                        <label for="marker-message" class="block text-gray-700 font-medium mb-1" data-lang-key="your-message">留言</label>
                        <textarea id="marker-message" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none transition-all duration-300" placeholder="给Boom的留言..."></textarea>
                        <p class="text-xs text-gray-400 mt-1"><i class="fa fa-info-circle"></i> 分享你的故事，让全球粉丝看到</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-1" data-lang-key="add-photo">添加照片（可选）</label>
                        <div id="marker-photo-upload-area" class="border-2 border-dashed border-gray-200 rounded-lg p-6 text-center hover:border-primary hover:bg-gray-50 transition-all duration-300 cursor-pointer">
                            <input type="file" id="marker-photo-upload" accept="image/*" class="hidden">
                            <i class="fa fa-cloud-upload text-4xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500" data-lang-key="upload-photo">点击上传照片</p>
                            <p class="text-gray-400 text-sm mt-1" data-lang-key="photo-format">支持JPG、PNG格式，最大5MB</p>
                        </div>
                        <div id="marker-photo-preview" class="mt-3 hidden">
                            <div class="relative group">
                                <img id="marker-preview-img" src="" alt="预览" class="w-full h-48 object-cover rounded-lg transition-all duration-300 group-hover:brightness-90">
                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                                    <button id="remove-marker-photo" class="text-white hover:text-gray-200">
                                        <i class="fa fa-times-circle text-2xl"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="submit-marker-btn" class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-lg font-medium transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <span data-lang-key="submit-marker">提交标记</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 评论模态框 -->
    <div id="comment-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 modal-backdrop-enter">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto shadow-2xl modal-enter">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold" data-lang-key="comments">评论</h3>
                <button id="close-comment-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="comments-list" class="p-6 space-y-4 max-h-[300px] overflow-y-auto">
                <!-- 评论将在这里动态生成 -->
            </div>
            <div class="p-6 border-t border-gray-200">
                <div class="flex items-start">
                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                        <i class="fa fa-user text-primary"></i>
                    </div>
                    <div class="flex-1">
                        <textarea id="comment-input" rows="2" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none" placeholder="写下你的评论..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button id="post-comment-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-1.5 rounded-full font-medium transition-custom">
                                <span data-lang-key="post-comment">发表评论</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 返回顶部按钮 -->
    <a href="#" class="fixed bottom-8 right-8 w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white shadow-lg hover:bg-secondary transition-custom z-40">
        <i class="fa fa-arrow-up"></i>
    </a>

    <!-- JavaScript -->
    <!-- 模块化脚本导入 -->
    <script src="utils.js"></script>
    <script src="auth.js"></script>
    <script src="messages.js"></script>
    <!-- 保留一个非模块方式的引入，确保全局可访问 -->
<script src="map.js"></script>
    <script>
        // 页面主逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            const currentUser = checkLoginStatus();
            if (!currentUser) return; // 如果未登录，auth.js会重定向
            
            // 初始化页面
            initPage();
        });
        
        // 页面初始化函数
        function initPage() {
            // 初始化翻译
            changeLanguage(getCurrentLanguage());
            
            // 渲染留言列表
            renderMessages();
            
            // 添加排序和搜索功能
            addSortAndSearchListeners();
            
            // 创建星星动画
            createStars();
            
            // 初始化标签切换
            initializeTabs();
            
            // 添加滚动效果 - 导航栏样式变化
            addNavbarScrollEffect();
            
            // 添加事件监听器
            addEventListeners();
        }
        
        // 初始化标签切换
        function initializeTabs() {
            // 默认显示留言墙
            switchTab('message-tab');
            
            // 添加标签点击事件监听
            document.querySelectorAll('[id="message-tab"]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab('message-tab');
                });
            });
            
            document.querySelectorAll('[id="map-tab"]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab('map-tab');
                });
            });
        }
        
        // 添加导航栏滚动效果
        function addNavbarScrollEffect() {
            const navbar = document.getElementById('navbar');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    navbar.classList.add('shadow-md');
                    navbar.classList.remove('shadow-sm');
                } else {
                    navbar.classList.remove('shadow-md');
                    navbar.classList.add('shadow-sm');
                }
            });
        }
        
        // 添加所有事件监听器
        function addEventListeners() {
            // 语言切换事件
            setupLanguageSwitching();
            
            // 移动端菜单切换
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });
            
            // 退出登录功能
            document.getElementById('logout-btn').addEventListener('click', () => {
                logoutUser();
            });
            
            // 发布留言
            document.getElementById('post-message-btn')?.addEventListener('click', postMessage);
            
            // 图片上传
            setupImageUpload();
            
            // 评论功能
            setupCommentModal();
            
            // 地图标记功能
            setupMapFunctions();
        }
        
        // 设置语言切换
        function setupLanguageSwitching() {
            // 语言切换事件监听
            document.getElementById('language-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('language-dropdown')?.classList.toggle('hidden');
            });
            
            document.getElementById('mobile-lang-btn')?.addEventListener('click', () => {
                document.getElementById('mobile-lang-menu')?.classList.toggle('hidden');
            });
            
            document.querySelectorAll('#language-dropdown a, #mobile-lang-menu a').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const lang = option.getAttribute('data-lang');
                    changeLanguage(lang);
                });
            });
            
            // 点击外部关闭下拉菜单
            document.addEventListener('click', () => {
                document.getElementById('language-dropdown')?.classList.add('hidden');
                document.getElementById('mobile-lang-menu')?.classList.add('hidden');
            });
        }
        
        // 设置图片上传
        function setupImageUpload() {
            document.getElementById('add-image-btn')?.addEventListener('click', function() {
                document.getElementById('image-upload')?.click();
            });
            
            document.getElementById('image-upload')?.addEventListener('change', handleImageUpload);
        }
        
        // 设置评论模态框
        function setupCommentModal() {
            document.getElementById('post-comment-btn')?.addEventListener('click', postComment);
            document.getElementById('close-comment-modal')?.addEventListener('click', function() {
                document.getElementById('comment-modal')?.classList.add('hidden');
            });
        }
        
        // 设置地图功能
        function setupMapFunctions() {
            document.getElementById('add-marker-btn')?.addEventListener('click', function() {
                document.getElementById('add-marker-modal')?.classList.remove('hidden');
            });
            
            document.getElementById('close-marker-modal')?.addEventListener('click', function() {
                document.getElementById('add-marker-modal')?.classList.add('hidden');
                resetMarkerForm();
            });
            
            document.getElementById('submit-marker-btn')?.addEventListener('click', submitMarker);
            
            // 标记照片上传
            document.getElementById('marker-photo-upload-area')?.addEventListener('click', function() {
                document.getElementById('marker-photo-upload')?.click();
            });
            
            document.getElementById('marker-photo-upload')?.addEventListener('change', handleMarkerPhotoUpload);
            
            document.getElementById('remove-marker-photo')?.addEventListener('click', function() {
                document.getElementById('marker-photo-upload')?.value = '';
                document.getElementById('marker-photo-preview')?.classList.add('hidden');
            });
        }
        
        // 标签切换功能
        function switchTab(tabId) {
            // 获取所有标签和内容区域
            const tabs = ['message-tab', 'map-tab'];
            const contents = ['messages-content', 'map-content'];
            
            // 重置所有标签样式
            tabs.forEach(id => {
                // 获取所有同名标签（桌面和移动）
                const tabElements = document.querySelectorAll(`[id="${id}"]`);
                tabElements.forEach(element => {
                    // 根据元素类型应用不同的样式
                    if (element.tagName === 'A') {
                        // 对于链接类型的标签
                        element.classList.remove('text-primary', 'bg-primary/5', 'tab-active');
                        element.classList.add('text-gray-600');
                    } else {
                        // 对于按钮类型的标签
                        element.classList.remove('text-primary', 'bg-primary/5', 'tab-active');
                        element.classList.add('text-gray-600');
                    }
                });
            });
            
            // 隐藏所有内容
            contents.forEach(id => {
                const content = document.getElementById(id);
                if (content) {
                    content.classList.add('hidden');
                }
            });
            
            // 激活选中的标签
            const activeTabElements = document.querySelectorAll(`[id="${tabId}"]`);
            activeTabElements.forEach(element => {
                if (element.tagName === 'A') {
                    element.classList.add('text-primary', 'bg-primary/5', 'tab-active');
                    element.classList.remove('text-gray-600');
                } else {
                    element.classList.add('text-primary', 'bg-primary/5', 'tab-active');
                    element.classList.remove('text-gray-600');
                }
            });
            
            // 显示对应内容
            const contentId = tabId === 'message-tab' ? 'messages-content' : 'map-content';
            const activeContent = document.getElementById(contentId);
            if (activeContent) {
                activeContent.classList.remove('hidden');
                activeContent.classList.add('animate-fade-in');
            }
            
            // 特殊处理地图标签
            if (tabId === 'map-tab') {
                const mapLoading = document.getElementById('map-loading');
                if (mapLoading) mapLoading.classList.remove('hidden');
                // 初始化地图（如果尚未初始化）
                if (!window.mapInitialized) {
                    initializeMap();
                }
            }
        }
        
        // 创建星星动画效果
        function createStars() {
            const container = document.getElementById('stars-container');
            if (!container) return;
            
            const starCount = 50;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star-animation';
                
                // 随机位置和大小
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 4 + 1}px`;
                star.style.height = star.style.width;
                star.style.opacity = Math.random() * 0.9 + 0.1;
                star.style.setProperty('--duration', `${Math.random() * 4 + 1}s`);
                star.style.animationDelay = `${Math.random() * 5}s`;
                
                // 为一些星星添加额外的发光效果
                if (Math.random() > 0.7) {
                    star.style.boxShadow = '0 0 8px rgba(255, 255, 255, 0.8)';
                }
                
                container.appendChild(star);
            }
        }

        function changeLanguage(lang) {
            if (!translations[lang]) return;
            
            // 更新页面上所有带有data-lang-key属性的元素
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            
            let langText = '中文';
            if (lang === 'en') {
                langText = 'English';
            } else if (lang === 'th') {
                langText = 'ภาษาไทย';
            }
            
            document.getElementById('current-language').textContent = langText;
            document.getElementById('language-dropdown').classList.add('hidden');
            document.getElementById('mobile-lang-menu').classList.add('hidden');
            
            // 保存语言偏好到localStorage
            localStorage.setItem('preferredLanguage', lang);
            currentLang = lang;
        }

        // 初始化语言
        changeLanguage(currentLang);

        // 语言切换事件监听
        document.getElementById('language-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('language-dropdown').classList.toggle('hidden');
        });

        document.getElementById('mobile-lang-btn').addEventListener('click', () => {
            document.getElementById('mobile-lang-menu').classList.toggle('hidden');
        });

        document.querySelectorAll('#language-dropdown a, #mobile-lang-menu a').forEach(option => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                const lang = option.getAttribute('data-lang');
                changeLanguage(lang);
            });
        });

        // 点击外部关闭下拉菜单
        document.addEventListener('click', () => {
            document.getElementById('language-dropdown').classList.add('hidden');
            document.getElementById('mobile-lang-menu').classList.add('hidden');
        });

        // 移动端菜单切换
        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        // 退出登录功能
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm(translations[currentLang]['logout-confirm'])) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                alert(translations[currentLang]['logout-success']);
                window.location.href = 'login.html';
            }
        });

        // 统一标签切换功能
        function switchTab(tabId) {
            // 获取所有标签和内容区域
            const tabs = ['message-tab', 'map-tab'];
            const contents = ['messages-content', 'map-content'];
            
            // 重置所有标签样式
            tabs.forEach(id => {
                // 获取所有同名标签（桌面和移动）
                const tabElements = document.querySelectorAll(`[id="${id}"]`);
                tabElements.forEach(element => {
                    // 根据元素类型应用不同的样式
                    if (element.tagName === 'A') {
                        // 对于链接类型的标签
                        element.classList.remove('text-primary', 'bg-primary/5', 'tab-active');
                        element.classList.add('text-gray-600');
                    } else {
                        // 对于按钮类型的标签
                        element.classList.remove('text-primary', 'bg-primary/5', 'tab-active');
                        element.classList.add('text-gray-600');
                    }
                });
            });
            
            // 隐藏所有内容
            contents.forEach(id => {
                const content = document.getElementById(id);
                if (content) {
                    content.classList.add('hidden');
                }
            });
            
            // 激活选中的标签
            const activeTabElements = document.querySelectorAll(`[id="${tabId}"]`);
            activeTabElements.forEach(element => {
                if (element.tagName === 'A') {
                    element.classList.add('text-primary', 'bg-primary/5', 'tab-active');
                    element.classList.remove('text-gray-600');
                } else {
                    element.classList.add('text-primary', 'bg-primary/5', 'tab-active');
                    element.classList.remove('text-gray-600');
                }
            });
            
            // 显示对应内容
            const contentId = tabId === 'message-tab' ? 'messages-content' : 'map-content';
            const activeContent = document.getElementById(contentId);
            if (activeContent) {
                activeContent.classList.remove('hidden');
                activeContent.classList.add('animate-fade-in');
            }
            
            // 特殊处理地图标签
            if (tabId === 'map-tab') {
                const mapLoading = document.getElementById('map-loading');
                if (mapLoading) mapLoading.classList.remove('hidden');
                // 初始化地图（如果尚未初始化）
                if (!window.mapInitialized) {
                    initializeMap();
                }
            }
        }
        
        // 添加标签点击事件监听
        document.querySelectorAll('[id="message-tab"]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab('message-tab');
            });
        });
        
        document.querySelectorAll('[id="map-tab"]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab('map-tab');
            });
        });

        // 粉丝留言墙功能
        const messagesKey = 'fanMessages';
        const commentsKey = 'messageComments';
        
        // 当前排序方式
        let currentSort = 'latest';
        let currentSearch = '';

        // 获取保存的留言数据
        function getMessages() {
            const messages = localStorage.getItem(messagesKey);
            return messages ? JSON.parse(messages) : [];
        }

        // 保存留言数据
        function saveMessages(messages) {
            localStorage.setItem(messagesKey, JSON.stringify(messages));
            // 重新渲染消息列表
            renderMessages();
        }
        
        // 排序消息
        function sortMessages(messages) {
            const sortedMessages = [...messages];
            
            switch(currentSort) {
                case 'popular':
                    return sortedMessages.sort((a, b) => {
                        const likesA = a.likes || 0;
                        const likesB = b.likes || 0;
                        return likesB - likesA;
                    });
                case 'mostComments':
                    return sortedMessages.sort((a, b) => {
                        const commentsA = getCommentsForMessage(a.id).length;
                        const commentsB = getCommentsForMessage(b.id).length;
                        return commentsB - commentsA;
                    });
                case 'latest':
                default:
                    return sortedMessages.sort((a, b) => {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
            }
        }
        
        // 过滤消息
        function filterMessages(messages) {
            if (!currentSearch) return messages;
            
            const searchTerm = currentSearch.toLowerCase();
            return messages.filter(message => {
                return message.content.toLowerCase().includes(searchTerm) ||
                       message.username.toLowerCase().includes(searchTerm);
            });
        }
        
        // 设置排序
        function setSort(sortType) {
            currentSort = sortType;
            
            // 更新排序按钮样式
            document.querySelectorAll('[data-sort]').forEach(btn => {
                if (btn.dataset.sort === sortType) {
                    btn.classList.add('text-primary', 'bg-primary/5');
                    btn.classList.remove('text-gray-600', 'hover:text-primary', 'hover:bg-primary/5');
                } else {
                    btn.classList.remove('text-primary', 'bg-primary/5');
                    btn.classList.add('text-gray-600', 'hover:text-primary', 'hover:bg-primary/5');
                }
            });
            
            // 重新渲染消息
            renderMessages();
        }
        
        // 设置搜索
        function setSearch(searchTerm) {
            currentSearch = searchTerm;
            renderMessages();
        }

        // 获取保存的评论数据
        function getComments() {
            const comments = localStorage.getItem(commentsKey);
            return comments ? JSON.parse(comments) : {};
        }

        // 保存评论数据
        function saveComments(comments) {
            localStorage.setItem(commentsKey, JSON.stringify(comments));
        }

        // 渲染留言列表
        function renderMessages() {
            const messagesList = document.getElementById('messages-list');
            const messagesLoading = document.getElementById('messages-loading');
            
            // 显示加载状态
            if (messagesLoading) messagesLoading.classList.remove('hidden');
            
            // 获取留言数据
            const allMessages = getMessages();
            
            // 过滤和排序
            const filteredMessages = filterMessages(allMessages);
            const sortedMessages = sortMessages(filteredMessages);
            
            messagesList.innerHTML = '';
            
            // 隐藏加载状态
            if (messagesLoading) messagesLoading.classList.add('hidden');
            
            if (sortedMessages.length === 0) {
                messagesList.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-2xl">
                        <i class="fa fa-comments-o text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">${currentSearch ? '没有找到匹配的留言' : '暂无留言，快来发表第一条留言吧！'}</p>
                    </div>
                `;
                return;
            }

            // 渲染排序后的消息
            sortedMessages.forEach(message => {
                const isLiked = message.likes && message.likes.includes(currentUser.username);
                const likesCount = message.likes ? message.likes.length : 0;
                const comments = getComments()[message.id] || [];
                
                const messageCard = document.createElement('div');
                messageCard.className = 'bg-white rounded-2xl shadow-md p-6 message-card transition-custom';
                messageCard.setAttribute('data-message-id', message.id);
                
                messageCard.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mr-4">
                            <i class="fa fa-user text-primary text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${message.username}</h4>
                                    <p class="text-gray-500 text-sm">${formatDate(message.timestamp)}</p>
                                </div>
                            </div>
                            <p class="mt-2 text-gray-700">${escapeHTML(message.content)}</p>
                            ${message.images && message.images.length > 0 ? `
                                <div class="mt-3 grid grid-cols-2 gap-2">
                                    ${message.images.map(img => `
                                        <img src="${img}" alt="用户上传图片" class="w-full h-32 object-cover rounded-lg">
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="mt-4 flex items-center space-x-6">
                                <button class="like-btn flex items-center text-gray-500 hover:text-primary transition-custom ${isLiked ? 'text-primary' : ''}">
                                    <i class="fa fa-heart mr-2"></i>
                                    <span>${likesCount}</span>
                                </button>
                                <button class="comment-btn flex items-center text-gray-500 hover:text-primary transition-custom">
                                    <i class="fa fa-comment mr-2"></i>
                                    <span>${comments.length}</span>
                                </button>
                            </div>
                            ${comments.length > 0 ? `
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <div class="space-y-3">
                                        ${comments.slice(0, 2).map(comment => `
                                            <div class="flex items-start">
                                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-2 flex-shrink-0">
                                                    <i class="fa fa-user text-gray-400"></i>
                                                </div>
                                                <div class="flex-1">
                                                    <div class="flex justify-between">
                                                        <p class="font-medium text-gray-900 text-sm">${comment.username}</p>
                                                        <p class="text-gray-400 text-xs">${formatDate(comment.timestamp)}</p>
                                                    </div>
                                                    <p class="text-gray-600 text-sm">${escapeHTML(comment.content)}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${comments.length > 2 ? `
                                        <button class="view-all-comments text-primary hover:text-primary/80 text-sm mt-2">
                                            <span data-lang-key="view-all">查看全部</span> ${comments.length} <span data-lang-key="comments">评论</span>
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                messagesList.appendChild(messageCard);
            });

            // 添加事件监听器
            addMessageEventListeners();
        }, 500); // 500ms延迟，模拟网络加载

        // 添加排序和搜索事件监听器
        function addSortAndSearchListeners() {
            // 添加排序按钮事件监听
            document.querySelectorAll('[data-sort]').forEach(btn => {
                btn.addEventListener('click', () => {
                    setSort(btn.dataset.sort);
                });
            });
            
            // 添加搜索事件监听
            const searchInput = document.getElementById('message-search');
            if (searchInput) {
                // 防抖搜索
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        setSearch(e.target.value);
                    }, 300);
                });
            }
        }
        
        // 添加留言事件监听器
        function addMessageEventListeners() {
            // 点赞按钮
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const messageId = this.closest('.message-card').getAttribute('data-message-id');
                    toggleLike(messageId, this);
                });
            });

            // 评论按钮和查看全部评论
            document.querySelectorAll('.comment-btn, .view-all-comments').forEach(btn => {
                btn.addEventListener('click', function() {
                    const messageId = this.closest('.message-card').getAttribute('data-message-id');
                    openCommentModal(messageId);
                });
            });
        }

        // 切换点赞状态
        function toggleLike(messageId, button) {
            const messages = getMessages();
            const message = messages.find(m => m.id === messageId);
            
            if (!message.likes) {
                message.likes = [];
            }
            
            const likeIndex = message.likes.indexOf(currentUser.username);
            if (likeIndex > -1) {
                // 取消点赞
                message.likes.splice(likeIndex, 1);
                button.classList.remove('text-primary');
            } else {
                // 添加点赞
                message.likes.push(currentUser.username);
                button.classList.add('text-primary');
            }
            
            saveMessages(messages);
            button.querySelector('span').textContent = message.likes.length;
        }

        // 打开评论模态框
        function openCommentModal(messageId) {
            const messageCard = document.querySelector(`.message-card[data-message-id="${messageId}"]`);
            const username = messageCard.querySelector('h4').textContent;
            const comments = getComments()[messageId] || [];
            const commentsList = document.getElementById('comments-list');
            
            // 保存当前消息ID
            commentsList.setAttribute('data-message-id', messageId);
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-comment-o text-2xl mb-2"></i>
                        <p data-lang-key="no-comments">暂无评论，快来发表第一条评论吧！</p>
                    </div>
                `;
            } else {
                commentsList.innerHTML = '';
                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'flex items-start';
                    commentEl.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fa fa-user text-gray-400"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <p class="font-medium text-gray-900">${comment.username}</p>
                                <p class="text-gray-400 text-sm">${formatDate(comment.timestamp)}</p>
                            </div>
                            <p class="text-gray-600">${escapeHTML(comment.content)}</p>
                        </div>
                    `;
                    commentsList.appendChild(commentEl);
                });
            }
            
            // 显示模态框
            document.getElementById('comment-modal').classList.remove('hidden');
        }

        // 发布评论
        document.getElementById('post-comment-btn').addEventListener('click', function() {
            const messageId = document.getElementById('comments-list').getAttribute('data-message-id');
            const commentInput = document.getElementById('comment-input');
            const content = commentInput.value.trim();
            
            if (!content) return;
            
            // 获取现有评论
            const comments = getComments();
            if (!comments[messageId]) {
                comments[messageId] = [];
            }
            
            // 添加新评论
            comments[messageId].push({
                id: Date.now().toString(),
                username: currentUser.username,
                content: content,
                timestamp: new Date().toISOString()
            });
            
            // 保存评论
            saveComments(comments);
            
            // 更新UI
            commentInput.value = '';
            renderMessages(); // 重新渲染留言列表以更新评论数
            openCommentModal(messageId); // 重新打开评论模态框以显示新评论
            
            alert(translations[currentLang]['comment-posted']);
        });

        // 关闭评论模态框
        document.getElementById('close-comment-modal').addEventListener('click', function() {
            document.getElementById('comment-modal').classList.add('hidden');
        });

        // 发布留言
        document.getElementById('post-message-btn').addEventListener('click', function() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content) {
                // 添加错误提示
                messageInput.classList.add('border-red-500');
                setTimeout(() => {
                    messageInput.classList.remove('border-red-500');
                }, 2000);
                return;
            }
            
            // 禁用按钮防止重复提交
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 发布中...';
            
            // 获取预览图片
            const imagePreviews = document.querySelectorAll('#image-preview-container img');
            const images = Array.from(imagePreviews).map(img => img.src);
            
            // 获取现有留言
            const messages = getMessages();
            
            // 添加新留言
            messages.push({
                id: Date.now().toString(),
                username: currentUser.username,
                content: content,
                images: images,
                likes: [],
                timestamp: new Date().toISOString()
            });
            
            // 保存留言
            saveMessages(messages); // 修复：使用正确的保存函数
            
            // 模拟网络延迟
            setTimeout(() => {
                // 更新UI
                messageInput.value = '';
                document.getElementById('image-preview-container').innerHTML = '';
                document.getElementById('image-preview-container').classList.add('hidden');
                renderMessages();
                
                // 显示成功提示
                showNotification(translations[currentLang]['message-posted'], 'success');
                
                // 恢复按钮状态
                btn.disabled = false;
                btn.innerHTML = originalText;
            }, 800);
        });

        // 图片上传预览
        document.getElementById('add-image-btn').addEventListener('click', function() {
            document.getElementById('image-upload').click();
        });

        document.getElementById('image-upload').addEventListener('change', function(e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('image-preview-container');
            
            previewContainer.classList.remove('hidden');
            
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'relative';
                        imgContainer.innerHTML = `
                            <img src="${event.target.result}" alt="预览" class="w-full h-32 object-cover rounded-lg">
                            <button class="absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center remove-image">
                                <i class="fa fa-times text-xs"></i>
                            </button>
                        `;
                        previewContainer.appendChild(imgContainer);
                        
                        // 添加移除按钮事件
                        imgContainer.querySelector('.remove-image').addEventListener('click', function() {
                            imgContainer.remove();
                            if (previewContainer.children.length === 0) {
                                previewContainer.classList.add('hidden');
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // 清空input，允许重复选择相同文件
            this.value = '';
        });

        // 使用模块化的星光地图功能
        // 显示通知的辅助函数
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-20 opacity-0 z-50`;
            
            // 根据类型设置样式
            let bgColor, textColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-primary';
                    textColor = 'text-white';
                    icon = 'fa-info-circle';
            }
            
            notification.classList.add(...bgColor.split(' '), ...textColor.split(' '));
            
            // 设置通知内容
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fa ${icon} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 初始化星光地图
        async function initStarMap() {
            try {
                // 显示加载状态
                const mapLoading = document.getElementById('map-loading');
                if (mapLoading) mapLoading.classList.remove('hidden');
                
                // 初始化地图
                const map = await window.starMap.initializeMap('map', {
                    accessToken: 'pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2wxeXpldGhtMDNvNjNqcW1iNjc5OGZrbSJ9.2X83XK9Vf5gO9jK9qDcQIw', // 示例密钥
                    style: 'mapbox://styles/mapbox/light-v10',
                    center: [105.8412, 21.0285], // 北京作为默认中心
                    zoom: 3,
                    // 添加星空背景效果
                    enableStarBackground: true
                });
                
                // 添加示例标记数据（仅在没有标记时）
                window.starMap.addExampleMarkers();
                
                // 加载标记
                window.starMap.loadMarkers(currentUser, showNotification);
                
                // 更新统计信息
                window.starMap.updateMapStats();
                
                // 更新统计数字动画
                const stats = window.starMap.getStats();
                window.starMap.animateNumber(document.getElementById('total-fans'), 0, stats.totalUsers || 15234);
                window.starMap.animateNumber(document.getElementById('total-markers'), 0, stats.totalMarkers || 8765);
                window.starMap.animateNumber(document.getElementById('total-cities'), 0, stats.totalCities || 234);
                window.starMap.animateNumber(document.getElementById('total-countries'), 0, stats.totalCountries || 45);
                
                // 隐藏加载状态
                if (mapLoading) {
                    mapLoading.style.opacity = '0';
                    setTimeout(() => {
                        mapLoading.classList.add('hidden');
                    }, 500);
                }
                
                // 地图加载完成动画
                const mapContainer = document.getElementById('map');
                mapContainer.style.opacity = '0';
                mapContainer.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    mapContainer.style.opacity = '1';
                }, 100);
                
            } catch (error) {
                console.error('地图初始化失败:', error);
                const mapLoading = document.getElementById('map-loading');
                if (mapLoading) {
                    mapLoading.innerHTML = `
                        <i class="fa fa-exclamation-circle text-red-500 text-4xl mb-2"></i>
                        <p class="text-gray-600" data-lang-key="map-error">地图加载失败，请刷新页面重试</p>
                        <p class="text-sm text-gray-500 mt-2">错误详情: ${error.message}</p>
                    `;
                }
            }
        }

        // 打开添加标记模态框
        document.getElementById('add-marker-btn').addEventListener('click', function() {
            const modal = document.getElementById('add-marker-modal');
            const modalContent = modal.querySelector('.scale-95');
            
            modal.classList.remove('hidden');
            // 触发重排，确保动画生效
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        });

        // 关闭添加标记模态框
        document.getElementById('close-marker-modal').addEventListener('click', function() {
            closeMarkerModal();
        });
        
        function closeMarkerModal() {
            const modal = document.getElementById('add-marker-modal');
            const modalContent = modal.querySelector('.scale-95');
            
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    resetMarkerForm();
                }, 300);
            }, 10);
        }

        // 重置标记表单
        function resetMarkerForm() {
            document.getElementById('marker-city').value = '';
            document.getElementById('marker-message').value = '';
            document.getElementById('marker-photo-upload').value = '';
            document.getElementById('marker-photo-preview').classList.add('hidden');
        }

        // 标记照片上传预览
        document.getElementById('marker-photo-upload-area').addEventListener('click', function() {
            document.getElementById('marker-photo-upload').click();
        });

        document.getElementById('marker-photo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 检查文件大小（5MB限制）
            if (file.size > 5 * 1024 * 1024) {
                showNotification(translations[currentLang]['file-too-large'] || '照片大小不能超过5MB', 'error');
                this.value = '';
                return;
            }
            
            // 检查文件类型
            const validTypes = ['image/jpeg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showNotification(translations[currentLang]['invalid-file-type'] || '请上传JPG或PNG格式的图片', 'error');
                this.value = '';
                return;
            }
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('marker-preview-img').src = event.target.result;
                    document.getElementById('marker-photo-preview').classList.remove('hidden');
                    
                    // 添加淡入动画
                    const preview = document.getElementById('marker-photo-preview');
                    preview.style.opacity = '0';
                    preview.style.transition = 'opacity 0.3s ease';
                    void preview.offsetWidth;
                    preview.style.opacity = '1';
                };
                reader.readAsDataURL(file);
            }
        }

        // 移除标记照片
        document.getElementById('remove-marker-photo').addEventListener('click', function() {
            document.getElementById('marker-photo-upload').value = '';
            document.getElementById('marker-photo-preview').classList.add('hidden');
        });

        // 提交标记
        document.getElementById('submit-marker-btn').addEventListener('click', async function() {
            const city = document.getElementById('marker-city').value.trim();
            const message = document.getElementById('marker-message').value.trim();
            const previewImg = document.getElementById('marker-preview-img');
            const photo = previewImg.classList.contains('hidden') ? null : previewImg.src;
            const submitBtn = this;
            
            if (!city) {
                showNotification(translations[currentLang]['city-required'] || '请输入城市', 'error');
                return;
            }
            
            if (!message) {
                showNotification(translations[currentLang]['message-required'] || '请输入留言', 'error');
                return;
            }
            
            // 禁用提交按钮防止重复提交
            submitBtn.disabled = true;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 提交中...';
            
            try {
                // 模拟地理位置（实际项目中应该使用真实的地理位置API）
                const lng = 73 + Math.random() * 50; // 中国经度范围
                const lat = 18 + Math.random() * 30; // 中国纬度范围
                
                // 添加新标记
                const newMarker = window.starMap.addMarker({
                    username: currentUser.username,
                    city: city,
                    message: message,
                    photo: photo,
                    lng: lng,
                    lat: lat,
                    timestamp: new Date().toISOString(),
                    likes: []
                });
                
                // 模拟网络延迟
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // 更新地图
                const map = window.starMap.getMap();
                if (map) {
                    window.starMap.loadMarkers(currentUser, showNotification);
                    window.starMap.updateMapStats();
                    
                    // 移动到新标记位置
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 8,
                        essential: true,
                        duration: 1500,
                        easing: function(t) { return t * (2 - t); }
                    });
                    
                    // 创建星星动画效果
                    createStarAnimation(map, lng, lat);
                }
                
                // 关闭模态框并重置表单
                closeMarkerModal();
                
                // 更新统计数字
                const updatedStats = window.starMap.getStats();
                window.starMap.animateNumber(document.getElementById('total-markers'), parseInt(document.getElementById('total-markers').textContent.replace(/,/g, '')), updatedStats.totalMarkers);
                
                showNotification(translations[currentLang]['marker-added'] || '标记添加成功！', 'success');
                
            } catch (error) {
                console.error('提交标记失败:', error);
                showNotification(translations[currentLang]['marker-error'] || '标记添加失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
        
        // 我的位置按钮
        document.getElementById('my-location-btn').addEventListener('click', function() {
            const map = window.starMap.getMap();
            if (map) {
                // 模拟定位到亚洲地区
                map.easeTo({
                    center: [105.8412, 21.0285],
                    zoom: 4,
                    duration: 1500,
                    easing: function(t) {
                        return t * (2 - t);
                    }
                });
                
                showNotification(translations[currentLang]['located-asia'] || '已定位到亚洲区域', 'info');
            }
        });
        
        // 标志位，确保地图只初始化一次
        let mapInitialized = false;
        
        // 安全的地图初始化函数
        function safelyInitMap() {
            if (!mapInitialized && window.starMap && typeof window.starMap.initializeMap === 'function') {
                console.log('初始化星光地图...');
                mapInitialized = true;
                initStarMap().catch(error => {
                    console.error('地图初始化失败:', error);
                    showNotification('地图初始化失败，请刷新页面重试', 'error');
                    // 显示加载失败状态
                    const loadingElement = document.getElementById('map-loading');
                    if (loadingElement) {
                        loadingElement.innerHTML = `
                            <div class="text-red-500 text-4xl mb-4">⚠️</div>
                            <p class="text-gray-600 mt-4 text-lg">地图加载失败</p>
                            <button id="retry-map" class="mt-4 px-4 py-2 bg-primary text-white rounded-full hover:bg-primary/90">
                                重试
                            </button>
                        `;
                        loadingElement.classList.remove('hidden');
                        // 添加重试按钮事件
                        document.getElementById('retry-map').addEventListener('click', function() {
                            mapInitialized = false;
                            safelyInitMap();
                        });
                    }
                });
            }
        }
        
        // 当map.js模块加载完成后初始化地图
        window.addEventListener('starMapLoaded', function() {
            console.log('检测到starMapLoaded事件');
            safelyInitMap();
        });
        
        // 如果模块已经加载，则直接初始化
        if (window.starMap) {
            console.log('检测到starMap对象已存在');
            safelyInitMap();
        } else {
            console.warn('starMap对象未找到，等待加载...');
            // 设置超时检查
            setTimeout(() => {
                if (!window.starMap) {
                    console.error('超时：未加载starMap模块');
                    showNotification('地图模块加载超时', 'error');
                }
            }, 5000);
        }

        // 工具函数：格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return translations[currentLang]['just-now'] || '刚刚';
            if (diffMins < 60) return `${diffMins} ${translations[currentLang]['minutes-ago'] || '分钟前'}`;
            if (diffHours < 24) return `${diffHours} ${translations[currentLang]['hours-ago'] || '小时前'}`;
            if (diffDays < 30) return `${diffDays} ${translations[currentLang]['days-ago'] || '天前'}`;
            
            return date.toLocaleDateString(currentLang === 'zh' ? 'zh-CN' : currentLang === 'th' ? 'th-TH' : 'en-US');
        }

        // 工具函数：HTML转义
        function escapeHTML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // 创建星星动画效果
        function createStars() {
            const container = document.getElementById('stars-container');
            if (!container) return;
            
            const starCount = 50; // 增加星星数量
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star-animation';
                
                // 随机位置和大小
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 4 + 1}px`; // 增加最大星星大小
                star.style.height = star.style.width;
                star.style.opacity = Math.random() * 0.9 + 0.1; // 调整透明度范围
                star.style.setProperty('--duration', `${Math.random() * 4 + 1}s`); // 调整动画持续时间范围
                star.style.animationDelay = `${Math.random() * 5}s`;
                
                // 为一些星星添加额外的发光效果
                if (Math.random() > 0.7) {
                    star.style.boxShadow = '0 0 8px rgba(255, 255, 255, 0.8)';
                }
                
                container.appendChild(star);
            }
        }
        
        // 创建添加标记时的星星动画
        function createStarAnimation(map, lng, lat) {
            if (!map) return;
            
            // 获取地图容器
            const mapContainer = document.getElementById('map');
            
            // 转换地理坐标为屏幕坐标
            const point = map.project([lng, lat]);
            
            // 创建星星元素
            const star = document.createElement('div');
            star.className = 'star-animation';
            star.style.cssText = `
                position: absolute;
                left: ${point.x}px;
                top: ${point.y}px;
                width: 20px;
                height: 20px;
                background: rgba(255, 215, 0, 0.9);
                border-radius: 50%;
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
                transform: scale(0);
                pointer-events: none;
                z-index: 100;
            `;
            
            // 添加到地图容器
            mapContainer.appendChild(star);
            
            // 执行动画
            setTimeout(() => {
                star.style.transition = 'all 1s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                star.style.transform = 'scale(2)';
                star.style.opacity = '0';
                star.style.boxShadow = '0 0 40px rgba(255, 215, 0, 0.5)';
                
                // 创建一些小的星星粒子
                for (let i = 0; i < 5; i++) {
                    const particle = document.createElement('div');
                    const angle = (i / 5) * Math.PI * 2;
                    const distance = 30;
                    const x = point.x + Math.cos(angle) * distance;
                    const y = point.y + Math.sin(angle) * distance;
                    
                    particle.style.cssText = `
                        position: absolute;
                        left: ${point.x}px;
                        top: ${point.y}px;
                        width: 8px;
                        height: 8px;
                        background: rgba(255, 255, 255, 0.9);
                        border-radius: 50%;
                        box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
                        opacity: 0;
                        pointer-events: none;
                        z-index: 100;
                    `;
                    
                    mapContainer.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.style.transition = 'all 0.8s ease-out';
                        particle.style.left = `${x}px`;
                        particle.style.top = `${y}px`;
                        particle.style.opacity = '1';
                        
                        setTimeout(() => {
                            particle.style.opacity = '0';
                            setTimeout(() => {
                                if (mapContainer.contains(particle)) {
                                    particle.remove();
                                }
                            }, 800);
                        }, 400);
                    }, 10);
                }
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (mapContainer.contains(star)) {
                        star.remove();
                    }
                }, 1000);
            }, 10);
        }
        
        // 显示通知提示
        function showNotification(message, type = 'success') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl flex items-center z-50 transform transition-all duration-300 ease-in-out translate-y-0 opacity-0`;
            
            // 设置通知类型样式
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
                notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i> ${message}`;
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
                notification.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> ${message}`;
            } else if (type === 'info') {
                notification.classList.add('bg-blue-500', 'text-white');
                notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i> ${message}`;
            }
            
            // 添加到文档
            document.body.appendChild(notification);
            
            // 显示通知
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-0');
                notification.classList.add('translate-y-[-20px]', 'opacity-100');
            }, 10);
            
            // 自动关闭
            setTimeout(() => {
                notification.classList.remove('translate-y-[-20px]', 'opacity-100');
                notification.classList.add('translate-y-0', 'opacity-0');
                // 移除元素
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 初始化页面
        function init() {
            // 创建星星动画
            createStars();
            
            // 渲染留言列表
            renderMessages();
            
            // 添加排序和搜索功能
            addSortAndSearchListeners();
            
            // 初始化翻译
            changeLanguage(currentLang);
            
            // 添加滚动效果 - 导航栏样式变化
            const navbar = document.getElementById('navbar');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    navbar.classList.add('shadow-md');
                    navbar.classList.remove('shadow-sm');
                } else {
                    navbar.classList.remove('shadow-md');
                    navbar.classList.add('shadow-sm');
                }
            });
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', function() {
            init();
            // 延迟初始化社区功能增强模块，确保原始功能已加载
            if (typeof initCommunityFeatures === 'function') {
                setTimeout(initCommunityFeatures, 1000);
            }
        });
    </script>
</body>
</html>