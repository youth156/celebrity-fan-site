<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="community-page-title">ç²‰ä¸ç¤¾åŒº - BoomRaveewit</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- å¼•å…¥Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- å¼•å…¥Mapbox GL JSç”¨äºåœ°å›¾åŠŸèƒ½ -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <!-- å¼•å…¥ç¤¾åŒºåŠŸèƒ½å¢å¼ºæ¨¡å— -->
    <script src="community-features.js" defer></script>
    <!-- å¼•å…¥æ˜Ÿå…‰åœ°å›¾åŠŸèƒ½æ¨¡å— -->
    <!-- ç§»é™¤é‡å¤çš„æ¨¡å—å¼•å…¥ -->
    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
    <script src="./tailwind-fix.js"></script>
    <!-- è‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
            .transition-custom {
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            .backdrop-blur-sm {
                backdrop-filter: blur(4px);
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            /* é˜²æ­¢å†…å®¹è¢«åº•éƒ¨å¯¼èˆªé®æŒ¡ */
            .content-safe-bottom {
                padding-bottom: env(safe-area-inset-bottom, 80px);
            }
            /* å¹³æ»‘æ»šåŠ¨ */
            .smooth-scroll {
                scroll-behavior: smooth;
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px -8px rgba(108, 56, 255, 0.15);
            }
            
            /* å¡ç‰‡åŸºç¡€æ ·å¼ */
            .card {
                transition: all 0.3s ease;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            
            .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 24px -8px rgba(108, 56, 255, 0.15);
            }
            
            /* æ¶ˆæ¯å¡ç‰‡æ ·å¼ä¼˜åŒ– */
            .message-card {
                background: white;
                border-radius: 16px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .message-card:hover {
                box-shadow: 0 8px 16px -8px rgba(108, 56, 255, 0.15);
            }
            .tab-active {
                position: relative;
            }
            .tab-active::after {
                content: '';
                position: absolute;
                bottom: -1px;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 3px;
                background-color: #6C38FF;
                border-radius: 3px;
                transition: all 0.3s ease;
            }
        }
    </style>
    <!-- é¢„åŠ è½½å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* åœ°å›¾è‡ªå®šä¹‰æ ·å¼ */
        .mapboxgl-popup-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .mapboxgl-popup-close-button {
            font-size: 20px;
            color: #666;
        }
        .message-card {
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .message-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -8px rgba(108, 56, 255, 0.15);
            border-color: rgba(108, 56, 255, 0.1);
        }
        /* æ˜Ÿç©ºæ•ˆæœ */
        .star-animation {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal-enter {
            animation: modalFadeIn 0.3s ease-out;
        }
        .modal-backdrop-enter {
            animation: backdropFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes backdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border-top-color: #6C38FF;
            animation: spinner 0.8s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* å¹³æ»‘æ»šåŠ¨ */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-light to-gray-100 font-sans text-gray-800 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <header id="navbar" class="fixed w-full z-50 transition-all duration-300 bg-white/95 backdrop-blur-sm shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                        <i class="fa fa-star text-white text-xl"></i>
                    </div>
                    <span class="text-2xl font-display font-bold text-dark">BoomRaveewit</span>
                </a>
                
                <!-- æ¡Œé¢å¯¼èˆª -->
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="index.html#home" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="home">é¦–é¡µ</a>
                    <a href="index.html#about" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="about">å…³äº</a>
                    <a href="index.html#works" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="works">ä½œå“</a>
                    <a href="index.html#gallery" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="gallery">ç…§ç‰‡</a>
                    <a href="index.html#news" class="text-dark hover:text-primary transition-custom font-medium" data-lang-key="news">åŠ¨æ€</a>
                    <a href="community.html" class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-full font-medium transition-custom transform hover:scale-105" data-lang-key="community">ç²‰ä¸ç¤¾åŒº</a>
                      
                    <!-- è¯­è¨€åˆ‡æ¢ä¸‹æ‹‰èœå• -->
                    <div id="language-selector" class="relative ml-6">
                        <button id="language-btn" class="flex items-center space-x-2 bg-gray-100 hover:bg-primary text-gray-800 hover:text-white px-3 py-1.5 rounded-full transition-custom">
                            <i class="fa fa-globe"></i>
                            <span id="current-language">ä¸­æ–‡</span>
                            <i class="fa fa-chevron-down text-xs"></i>
                        </button>
                        <div id="language-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl overflow-hidden z-10 hidden">
                            <a href="#" data-lang="zh" class="block px-4 py-2 hover:bg-primary/10 text-gray-800 transition-custom">
                                <span class="flag-icon">ğŸ‡¨ğŸ‡³</span> ä¸­æ–‡
                            </a>
                            <a href="#" data-lang="en" class="block px-4 py-2 hover:bg-primary/10 text-gray-800 transition-custom">
                                <span class="flag-icon">ğŸ‡¬ğŸ‡§</span> English
                            </a>
                            <a href="#" data-lang="th" class="block px-4 py-2 hover:bg-primary/10 text-gray-800 transition-custom">
                                <span class="flag-icon">ğŸ‡¹ğŸ‡­</span> à¸ à¸²à¸©à¸²à¹„à¸—à¸¢
                            </a>
                        </div>
                    </div>
                </nav>
                
                <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
                <button id="menu-toggle" class="md:hidden text-dark text-2xl focus:outline-none">
                    <i class="fa fa-bars"></i>
                </button>
            </div>            
        </div>
        
        <!-- ç§»åŠ¨ç«¯å¯¼èˆªèœå• -->
        <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-gray-200">
            <div class="container mx-auto px-4 py-4 space-y-4">
                <a href="index.html#home" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="home">é¦–é¡µ</a>
                <a href="index.html#about" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="about">å…³äº</a>
                <a href="index.html#works" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="works">ä½œå“</a>
                <a href="index.html#gallery" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="gallery">ç…§ç‰‡</a>
                <a href="index.html#news" class="block text-dark hover:text-primary py-2 transition-custom" data-lang-key="news">åŠ¨æ€</a>
                <a href="community.html" class="block bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg font-medium transition-custom text-center mt-2" data-lang-key="community">ç²‰ä¸ç¤¾åŒº</a>
                
                <!-- ç§»åŠ¨ç«¯è¯­è¨€åˆ‡æ¢ -->
                <div class="pt-2 border-t border-gray-200">
                    <button id="mobile-lang-btn" class="flex items-center justify-between w-full text-dark py-2">
                        <span><i class="fa fa-globe mr-2"></i> <span data-lang-key="language">è¯­è¨€</span></span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </button>
                    <div id="mobile-lang-menu" class="hidden mt-2 space-y-1">
                        <a href="#" data-lang="zh" class="block px-4 py-2 hover:bg-primary/10 text-dark transition-custom">
                            <span class="flag-icon">ğŸ‡¨ğŸ‡³</span> ä¸­æ–‡
                        </a>
                        <a href="#" data-lang="en" class="block px-4 py-2 hover:bg-primary/10 text-dark transition-custom">
                            <span class="flag-icon">ğŸ‡¬ğŸ‡§</span> English
                        </a>
                        <a href="#" data-lang="th" class="block px-4 py-2 hover:bg-primary/10 text-dark transition-custom">
                            <span class="flag-icon">ğŸ‡¹ğŸ‡­</span> à¸ à¸²à¸©à¸²à¹„à¸—à¸¢
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- é¡µé¢å†…å®¹ -->
    <main class="pt-24 pb-24 lg:pb-20">
        <div class="container mx-auto px-4">
            <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
            <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 lg:hidden z-40">
                <div class="flex justify-around items-center h-16 overflow-hidden">
                    <!-- è°ƒæ•´æ¯ä¸ªå¯¼èˆªé¡¹çš„æ ·å¼ä»¥é€‚åº”äº”ä¸ªé€‰é¡¹ -->
                    <style scoped>
                        .fixed.bottom-0 nav a {
                            flex: 1;
                            max-width: 20%;
                        }
                    </style>
                    <a href="#" class="flex flex-col items-center justify-center text-primary" data-tab="messages">
                        <i class="fa fa-comments text-xl"></i>
                        <span class="text-xs mt-1" data-lang-key="message-wall">ç•™è¨€</span>
                    </a>
                    <a href="#" class="flex flex-col items-center justify-center text-gray-500" data-tab="map">
                        <i class="fa fa-map-marker text-xl"></i>
                        <span class="text-xs mt-1" data-lang-key="star-map">åœ°å›¾</span>
                    </a>
                    <a href="#" class="flex flex-col items-center justify-center text-gray-500">
                        <i class="fa fa-bell text-xl"></i>
                        <span class="text-xs mt-1">é€šçŸ¥</span>
                    </a>
                    <a href="#" class="flex flex-col items-center justify-center text-gray-500">
                        <i class="fa fa-user text-xl"></i>
                        <span class="text-xs mt-1">æˆ‘çš„</span>
                    </a>
                    <a href="https://youth156.github.io/pingtu/" target="_blank" class="flex flex-col items-center justify-center text-gray-500 hover:text-primary transition-colors">
                        <i class="fa fa-puzzle-piece text-xl"></i>
                        <span class="text-xs mt-1">æ‹¼å›¾</span>
                    </a>
                </div>
            </nav>

            <!-- ä¸‰æ å¸ƒå±€å®¹å™¨ -->
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- å·¦ä¾§è¾¹æ ï¼šç”¨æˆ·ä¿¡æ¯å’Œå¯¼èˆª -->
                <aside class="w-full lg:w-64 shrink-0">
                    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
                    <div class="bg-gradient-to-br from-primary/95 to-secondary/95 rounded-2xl p-6 shadow-xl text-white relative overflow-hidden transform transition-all duration-500 hover:shadow-2xl mb-6">
                        <!-- è£…é¥°æ˜Ÿæ˜Ÿæ•ˆæœ -->
                        <div id="stars-container"></div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center mb-4">
                                <div class="w-20 h-20 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center mr-4 transition-transform duration-300 hover:scale-105">
                                    <i class="fa fa-user-circle text-4xl text-white"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-shadow" id="welcome-message"><span id="username-display" class="text-primary"></span> <span data-lang-key="welcome">æ¬¢è¿å›æ¥</span></h2>
                                </div>
                            </div>
                            <p class="text-white/90 text-sm mb-4" data-lang-key="community-subtitle">åŠ å…¥Boomçš„ç²‰ä¸ç¤¾åŒºï¼Œä¸å…¨çƒç²‰ä¸äº’åŠ¨</p>
                            <button id="logout-btn" class="w-full bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-5 py-2 rounded-full font-medium transition-custom flex items-center justify-center transform hover:scale-105">
                                <i class="fa fa-sign-out mr-2"></i>
                                <span data-lang-key="logout">é€€å‡ºç™»å½•</span>
                            </button>
                        </div>
                    </div>

                    <!-- ç¤¾åŒºå¯¼èˆª -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6 card">
                        <h3 class="font-semibold text-gray-700 mb-3 px-2">ç¤¾åŒºå¯¼èˆª</h3>
                        <div class="space-y-1">
                            <button id="sidebar-message-tab" class="w-full flex items-center px-4 py-3 rounded-lg text-primary bg-primary/5 font-medium">
                                <i class="fa fa-comments mr-3 w-5 text-center"></i>
                                <span data-lang-key="message-wall">ç²‰ä¸ç•™è¨€å¢™</span>
                            </button>
                            <button id="sidebar-map-tab" class="w-full flex items-center px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium">
                                <i class="fa fa-map-marker mr-3 w-5 text-center"></i>
                                <span data-lang-key="star-map">æ˜Ÿå…‰åœ°å›¾</span>
                            </button>
                            <button class="w-full flex items-center px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium">
                                <i class="fa fa-calendar mr-3 w-5 text-center"></i>
                                <span>æ´»åŠ¨æ—¥å†</span>
                            </button>
                            <button class="w-full flex items-center px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium">
                                <i class="fa fa-trophy mr-3 w-5 text-center"></i>
                                <span>ç²‰ä¸æˆå°±</span>
                            </button>
                            <a href="https://youth156.github.io/pingtu/" target="_blank" class="w-full flex items-center px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition-colors hover:text-primary">
                        <i class="fa fa-puzzle-piece mr-3 w-5 text-center"></i>
                        <span>æ¢¦å¹»æ‹¼å›¾æ¸¸æˆ</span>
                    </a>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿç»Ÿè®¡ -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 card">
                        <h3 class="font-semibold text-gray-700 mb-3 px-2">ç¤¾åŒºç»Ÿè®¡</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <i class="fa fa-users text-primary mr-2"></i>
                                    <span class="text-sm text-gray-600" data-lang-key="total-fans">æ€»ç²‰ä¸æ•°</span>
                                </div>
                                <span class="font-bold text-primary" id="sidebar-total-fans">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <i class="fa fa-map-marker text-secondary mr-2"></i>
                                    <span class="text-sm text-gray-600" data-lang-key="total-markers">åœ°å›¾æ ‡è®°</span>
                                </div>
                                <span class="font-bold text-secondary" id="sidebar-total-markers">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <i class="fa fa-comments text-green-500 mr-2"></i>
                                    <span class="text-sm text-gray-600">ä»Šæ—¥ç•™è¨€</span>
                                </div>
                                <span class="font-bold text-green-500">0</span>
                            </div>
                        </div>
                    </div>
                </aside>
                
                <!-- ä¸»å†…å®¹åŒºåŸŸ -->
                <main class="flex-1">
                    <!-- å¯¼èˆªæ ‡ç­¾ï¼ˆæ¡Œé¢ç«¯ï¼‰ -->
                    <div class="bg-white rounded-xl shadow-sm p-1 mb-6 lg:hidden animate-slide-up">
                        <div class="flex rounded-lg overflow-hidden">
                            <button id="mobile-message-tab" class="flex-1 py-3 px-6 font-medium text-primary bg-primary/5 rounded-lg transition-custom tab-active" data-tab="messages">
                                <i class="fa fa-comments mr-2"></i>
                                <span data-lang-key="message-wall">ç²‰ä¸ç•™è¨€å¢™</span>
                            </button>
                            <button id="mobile-map-tab" class="flex-1 py-3 px-6 font-medium text-gray-600 hover:text-primary hover:bg-primary/5 rounded-lg transition-custom" data-tab="map">
                                <i class="fa fa-map-marker mr-2"></i>
                                <span data-lang-key="star-map">æ˜Ÿå…‰åœ°å›¾</span>
                            </button>
                        </div>
                    </div>

                    <!-- ç²‰ä¸ç•™è¨€å¢™ -->
                    <div id="messages-content" class="space-y-6 animate-fade-in">
                        <!-- å‘å¸ƒç•™è¨€åŒºåŸŸ -->
                        <div class="bg-white rounded-2xl shadow-md p-6 card">
                            <div class="flex items-start">
                                <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mr-4 flex-shrink-0">
                                    <i class="fa fa-user text-primary text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <textarea id="message-input" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-custom resize-none" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." data-lang-key="share-thoughts"></textarea>
                                    <div class="flex flex-wrap justify-between items-center gap-4 mt-4">
                                        <div class="flex space-x-4">
                                            <button class="text-gray-500 hover:text-primary transition-custom p-2 rounded-full hover:bg-primary/5" id="add-image-btn">
                                                <i class="fa fa-image text-xl"></i>
                                                <input type="file" id="image-upload" accept="image/*" class="hidden">
                                            </button>
                                            <button class="text-gray-500 hover:text-primary transition-custom p-2 rounded-full hover:bg-primary/5">
                                                <i class="fa fa-smile-o text-xl"></i>
                                            </button>
                                        </div>
                                        <button id="post-message-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-full font-medium transition-custom transform hover:scale-105 shadow-lg shadow-primary/20">
                                            <span data-lang-key="post-message">å‘å¸ƒç•™è¨€</span>
                                        </button>
                                    </div>
                                    <div id="image-preview-container" class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2 hidden">
                                        <!-- å›¾ç‰‡é¢„è§ˆå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç•™è¨€æ’åºå’Œè¿‡æ»¤ -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="bg-white rounded-xl shadow-sm p-2 flex">
                                <button class="px-4 py-2 rounded-lg text-primary bg-primary/5 font-medium" data-sort="latest">
                                    <span data-lang-key="latest">æœ€æ–°</span>
                                </button>
                                <button class="px-4 py-2 rounded-lg text-gray-600 hover:text-primary hover:bg-primary/5 font-medium" data-sort="popular">
                                    <span data-lang-key="popular">çƒ­é—¨</span>
                                </button>
                                <button class="px-4 py-2 rounded-lg text-gray-600 hover:text-primary hover:bg-primary/5 font-medium" data-sort="mostComments">
                                    <span>æœ€å¤šè¯„è®º</span>
                                </button>
                            </div>
                            <div class="relative">
                                <input type="text" id="message-search" placeholder="æœç´¢ç•™è¨€..." class="pl-10 pr-4 py-2 rounded-full border border-gray-200 focus:ring-2 focus:ring-primary focus:border-transparent w-full sm:w-auto">
                                <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>

                        <!-- ç•™è¨€åˆ—è¡¨ -->
                        <div id="messages-list" class="space-y-6">
                            <!-- ç•™è¨€å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            <!-- åˆå§‹åŠ è½½çŠ¶æ€ -->
                            <div id="messages-loading" class="text-center py-12 bg-gray-50 rounded-2xl hidden">
                                <div class="inline-block w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full loader"></div>
                                <p class="text-gray-500 mt-4" data-lang-key="loading">åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>

                    <!-- æ˜Ÿå…‰åœ°å›¾ -->
                    <div id="map-content" class="hidden animate-fade-in space-y-6">
                        <div class="bg-white rounded-2xl shadow-md p-6 card">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                <h3 class="text-xl font-bold flex items-center" data-lang-key="star-map-description">
                                    <i class="fa fa-globe text-primary mr-2"></i> åœ¨åœ°å›¾ä¸Šæ ‡è®°ä½ çš„ä½ç½®ï¼Œä¸å…¨çƒç²‰ä¸è¿æ¥
                                </h3>
                                <button id="add-marker-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-full font-medium transition-custom transform hover:scale-105 shadow-lg shadow-primary/20">
                                    <i class="fa fa-plus mr-2"></i>
                                    <span data-lang-key="add-marker">æ·»åŠ æ ‡è®°</span>
                                </button>
                            </div>
                            
                            <!-- ç²‰ä¸ç»Ÿè®¡ -->
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-xl p-4 text-center transition-all duration-300 hover:shadow-md hover:bg-primary/5">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-primary/10 rounded-full flex items-center justify-center">
                                        <i class="fa fa-users text-primary text-xl"></i>
                                    </div>
                                    <p class="text-3xl font-bold text-primary" id="total-fans">0</p>
                                    <p class="text-gray-500" data-lang-key="total-fans">æ€»ç²‰ä¸æ•°</p>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 text-center transition-all duration-300 hover:shadow-md hover:bg-secondary/5">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-secondary/10 rounded-full flex items-center justify-center">
                                        <i class="fa fa-map-marker text-secondary text-xl"></i>
                                    </div>
                                    <p class="text-3xl font-bold text-secondary" id="total-markers">0</p>
                                    <p class="text-gray-500" data-lang-key="total-markers">åœ°å›¾æ ‡è®°</p>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 text-center transition-all duration-300 hover:shadow-md hover:bg-green-500/5">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-green-500/10 rounded-full flex items-center justify-center">
                                        <i class="fa fa-building text-green-500 text-xl"></i>
                                    </div>
                                    <p class="text-3xl font-bold text-green-500" id="total-cities">0</p>
                                    <p class="text-gray-500" data-lang-key="total-cities">è¦†ç›–åŸå¸‚</p>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 text-center transition-all duration-300 hover:shadow-md hover:bg-blue-500/5">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-blue-500/10 rounded-full flex items-center justify-center">
                                        <i class="fa fa-flag text-blue-500 text-xl"></i>
                                    </div>
                                    <p class="text-3xl font-bold text-blue-500" id="total-countries">0</p>
                                    <p class="text-gray-500" data-lang-key="total-countries">è¦†ç›–å›½å®¶</p>
                                </div>
                            </div>
                        </div>

                        <!-- åœ°å›¾å®¹å™¨ -->
                        <div class="bg-white rounded-2xl shadow-md overflow-hidden card relative transition-all duration-500 hover:shadow-xl">
                            <div id="map" class="w-full h-[60vh] min-h-[500px]"></div>
                            <!-- åœ°å›¾åŠ è½½çŠ¶æ€ -->
                            <div id="map-loading" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden transition-opacity duration-500">
                                <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
                                <p class="text-gray-600 mt-4 text-lg" data-lang-key="loading">åœ°å›¾åŠ è½½ä¸­...</p>
                                <p class="text-gray-400 text-sm mt-2">è¿æ¥å…¨çƒç²‰ä¸ï¼Œç‚¹äº®æ˜æ˜Ÿæ¢¦æƒ³</p>
                            </div>
                            
                            <!-- åœ°å›¾æ“ä½œæŒ‰é’® -->
                            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm rounded-full px-4 py-2 shadow-lg flex gap-4 z-5 transition-all duration-300 hover:bg-white">
                                <button id="add-marker-btn" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-full hover:bg-primary/90 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                    <i class="fa fa-plus"></i>
                                    <span>æ·»åŠ æ ‡è®°</span>
                                </button>
                                <button id="my-location-btn" class="flex items-center gap-1 px-3 py-2 bg-white text-gray-700 border border-gray-200 rounded-full hover:bg-gray-50 transition-all duration-300 shadow-sm transform hover:-translate-y-0.5">
                                    <i class="fa fa-location-arrow"></i>
                                    <span>æˆ‘çš„ä½ç½®</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </main>
                
                <!-- å³ä¾§è¾¹æ  -->
                <aside class="w-full lg:w-72 shrink-0 hidden lg:block">
                    <!-- çƒ­é—¨è¯é¢˜ -->
                    <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 card">
                        <h3 class="text-lg font-bold mb-4 flex items-center" data-lang-key="hot-topics">
                            <i class="fa fa-fire text-secondary mr-2"></i> çƒ­é—¨è¯é¢˜
                        </h3>
                        <div class="space-y-3">
                            <a href="#" class="block p-3 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-custom">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">#Boomæ–°å‰§</span>
                                    <span class="text-xs bg-white px-2 py-1 rounded-full">1,283 è®¨è®º</span>
                                </div>
                                <p class="text-xs text-primary/80 mt-1">æœ€æ–°æ›´æ–°: 2åˆ†é’Ÿå‰</p>
                            </a>
                            <a href="#" class="block p-3 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 transition-custom">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">#ç²‰ä¸è§é¢ä¼š</span>
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">856 è®¨è®º</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">æœ€æ–°æ›´æ–°: 15åˆ†é’Ÿå‰</p>
                            </a>
                            <a href="#" class="block p-3 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 transition-custom">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">#ç”Ÿæ—¥ç¥ç¦</span>
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">624 è®¨è®º</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">æœ€æ–°æ›´æ–°: 32åˆ†é’Ÿå‰</p>
                            </a>
                        </div>
                        <button class="w-full mt-4 py-2 text-primary text-sm hover:text-primary/80 transition-custom">
                            <span data-lang-key="view-all">æŸ¥çœ‹å…¨éƒ¨</span> <i class="fa fa-chevron-right ml-1 text-xs"></i>
                        </button>
                    </div>

                    <!-- å…¬å‘Šæ  -->
                    <div class="bg-gradient-to-br from-blue-500/90 to-purple-500/90 rounded-2xl shadow-sm p-5 mb-6 text-white">
                        <h3 class="text-lg font-bold mb-3 flex items-center">
                            <i class="fa fa-bullhorn mr-2"></i> ç¤¾åŒºå…¬å‘Š
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg">
                                <h4 class="font-medium">ç²‰ä¸è§é¢ä¼šå®‰æ’</h4>
                                <p class="text-sm text-white/80 mt-1">3æœˆ15æ—¥ï¼ŒåŒ—äº¬å›½å®¶ä¼šè®®ä¸­å¿ƒï¼Œå¿«æ¥æŠ¥åå‚åŠ ï¼</p>
                                <span class="inline-block mt-2 text-xs bg-white/20 px-2 py-0.5 rounded-full">é‡è¦</span>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg">
                                <h4 class="font-medium">ç¤¾åŒºè§„åˆ™æ›´æ–°</h4>
                                <p class="text-sm text-white/80 mt-1">æ–°çš„ç¤¾åŒºè¡Œä¸ºè§„èŒƒå·²ç”Ÿæ•ˆï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…ã€‚</p>
                                <span class="inline-block mt-2 text-xs bg-white/20 px-2 py-0.5 rounded-full">æœ€æ–°</span>
                            </div>
                        </div>
                    </div>

                    <!-- åœ¨çº¿ç²‰ä¸ -->
                    <div class="bg-white rounded-2xl shadow-sm p-5 card">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fa fa-circle text-green-500 mr-2 text-xs"></i> åœ¨çº¿ç²‰ä¸ (24)
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                                        <i class="fa fa-user text-primary"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">BoomOfficial</p>
                                        <p class="text-xs text-gray-500">å®˜æ–¹è´¦å·</p>
                                    </div>
                                </div>
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                        <i class="fa fa-user text-gray-400"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">è¶…çº§ç²‰ä¸</p>
                                        <p class="text-xs text-gray-500">åœ¨çº¿32åˆ†é’Ÿ</p>
                                    </div>
                                </div>
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                        <i class="fa fa-user text-gray-400"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">æ˜Ÿå…‰å®ˆæŠ¤è€…</p>
                                        <p class="text-xs text-gray-500">åœ¨çº¿15åˆ†é’Ÿ</p>
                                    </div>
                                </div>
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            </div>
                        </div>
                        <button class="w-full mt-4 py-2 text-primary text-sm hover:text-primary/80 transition-custom">
                            <span data-lang-key="view-all">æŸ¥çœ‹å…¨éƒ¨</span> <i class="fa fa-chevron-right ml-1 text-xs"></i>
                        </button>
                    </div>
                </aside>
            </div>
        </div>
    </main>
        </div>
    </main>

    <!-- æ·»åŠ æ ‡è®°æ¨¡æ€æ¡† -->
    <div id="add-marker-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto shadow-2xl transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold flex items-center" data-lang-key="add-your-marker">
                    <i class="fa fa-map-marker-alt text-primary mr-2"></i>
                    æ·»åŠ ä½ çš„æ ‡è®°
                </h3>
                <button id="close-marker-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="marker-city" class="block text-gray-700 font-medium mb-1" data-lang-key="city">åŸå¸‚</label>
                        <input type="text" id="marker-city" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300" placeholder="è¾“å…¥ä½ çš„åŸå¸‚">
                    </div>
                    <div>
                        <label for="marker-message" class="block text-gray-700 font-medium mb-1" data-lang-key="your-message">ç•™è¨€</label>
                        <textarea id="marker-message" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none transition-all duration-300" placeholder="ç»™Boomçš„ç•™è¨€..."></textarea>
                        <p class="text-xs text-gray-400 mt-1"><i class="fa fa-info-circle"></i> åˆ†äº«ä½ çš„æ•…äº‹ï¼Œè®©å…¨çƒç²‰ä¸çœ‹åˆ°</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-1" data-lang-key="add-photo">æ·»åŠ ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                        <div id="marker-photo-upload-area" class="border-2 border-dashed border-gray-200 rounded-lg p-6 text-center hover:border-primary hover:bg-gray-50 transition-all duration-300 cursor-pointer">
                            <input type="file" id="marker-photo-upload" accept="image/*" class="hidden">
                            <i class="fa fa-cloud-upload text-4xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500" data-lang-key="upload-photo">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</p>
                            <p class="text-gray-400 text-sm mt-1" data-lang-key="photo-format">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤§5MB</p>
                        </div>
                        <div id="marker-photo-preview" class="mt-3 hidden">
                            <div class="relative group">
                                <img id="marker-preview-img" src="" alt="é¢„è§ˆ" class="w-full h-48 object-cover rounded-lg transition-all duration-300 group-hover:brightness-90">
                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                                    <button id="remove-marker-photo" class="text-white hover:text-gray-200">
                                        <i class="fa fa-times-circle text-2xl"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="submit-marker-btn" class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-lg font-medium transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <span data-lang-key="submit-marker">æäº¤æ ‡è®°</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯„è®ºæ¨¡æ€æ¡† -->
    <div id="comment-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 modal-backdrop-enter">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto shadow-2xl modal-enter">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold" data-lang-key="comments">è¯„è®º</h3>
                <button id="close-comment-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="comments-list" class="p-6 space-y-4 max-h-[300px] overflow-y-auto">
                <!-- è¯„è®ºå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="p-6 border-t border-gray-200">
                <div class="flex items-start">
                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                        <i class="fa fa-user text-primary"></i>
                    </div>
                    <div class="flex-1">
                        <textarea id="comment-input" rows="2" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button id="post-comment-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-1.5 rounded-full font-medium transition-custom">
                                <span data-lang-key="post-comment">å‘è¡¨è¯„è®º</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <a href="#" class="fixed bottom-8 right-8 w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white shadow-lg hover:bg-secondary transition-custom z-40">
        <i class="fa fa-arrow-up"></i>
    </a>

    <!-- JavaScript -->
    <!-- æ¨¡å—åŒ–è„šæœ¬å¯¼å…¥ -->
    <script src="utils.js"></script>
    <script src="auth.js"></script>
    <script src="messages.js"></script>
    <!-- ä¿ç•™ä¸€ä¸ªéæ¨¡å—æ–¹å¼çš„å¼•å…¥ï¼Œç¡®ä¿å…¨å±€å¯è®¿é—® -->
<script src="map.js"></script>
    <script>
        // é¡µé¢ä¸»é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const currentUser = checkLoginStatus();
            if (!currentUser) return; // å¦‚æœæœªç™»å½•ï¼Œauth.jsä¼šé‡å®šå‘
            
            // åˆå§‹åŒ–é¡µé¢
            initPage();
        });
        
        // é¡µé¢åˆå§‹åŒ–å‡½æ•°
        function initPage() {
            // åˆå§‹åŒ–ç¿»è¯‘
            changeLanguage(getCurrentLanguage());
            
            // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
            renderMessages();
            
            // æ·»åŠ æ’åºå’Œæœç´¢åŠŸèƒ½
            addSortAndSearchListeners();
            
            // åˆ›å»ºæ˜Ÿæ˜ŸåŠ¨ç”»
            createStars();
            
            // åˆå§‹åŒ–æ ‡ç­¾åˆ‡æ¢
            initializeTabs();
            
            // æ·»åŠ æ»šåŠ¨æ•ˆæœ - å¯¼èˆªæ æ ·å¼å˜åŒ–
            addNavbarScrollEffect();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            addEventListeners();
        }
        
        // åˆå§‹åŒ–æ ‡ç­¾åˆ‡æ¢
        function initializeTabs() {
            // é»˜è®¤æ˜¾ç¤ºç•™è¨€å¢™
            switchTab('message-tab');
            
            // æ·»åŠ æ ‡ç­¾ç‚¹å‡»äº‹ä»¶ç›‘å¬
            document.querySelectorAll('[id="message-tab"]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab('message-tab');
                });
            });
            
            document.querySelectorAll('[id="map-tab"]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab('map-tab');
                });
            });
        }
        
        // æ·»åŠ å¯¼èˆªæ æ»šåŠ¨æ•ˆæœ
        function addNavbarScrollEffect() {
            const navbar = document.getElementById('navbar');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    navbar.classList.add('shadow-md');
                    navbar.classList.remove('shadow-sm');
                } else {
                    navbar.classList.remove('shadow-md');
                    navbar.classList.add('shadow-sm');
                }
            });
        }
        
        // æ·»åŠ æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        function addEventListeners() {
            // è¯­è¨€åˆ‡æ¢äº‹ä»¶
            setupLanguageSwitching();
            
            // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });
            
            // é€€å‡ºç™»å½•åŠŸèƒ½
            document.getElementById('logout-btn').addEventListener('click', () => {
                logoutUser();
            });
            
            // å‘å¸ƒç•™è¨€
            document.getElementById('post-message-btn')?.addEventListener('click', postMessage);
            
            // å›¾ç‰‡ä¸Šä¼ 
            setupImageUpload();
            
            // è¯„è®ºåŠŸèƒ½
            setupCommentModal();
            
            // åœ°å›¾æ ‡è®°åŠŸèƒ½
            setupMapFunctions();
        }
        
        // è®¾ç½®è¯­è¨€åˆ‡æ¢
        function setupLanguageSwitching() {
            // è¯­è¨€åˆ‡æ¢äº‹ä»¶ç›‘å¬
            document.getElementById('language-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('language-dropdown')?.classList.toggle('hidden');
            });
            
            document.getElementById('mobile-lang-btn')?.addEventListener('click', () => {
                document.getElementById('mobile-lang-menu')?.classList.toggle('hidden');
            });
            
            document.querySelectorAll('#language-dropdown a, #mobile-lang-menu a').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const lang = option.getAttribute('data-lang');
                    changeLanguage(lang);
                });
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', () => {
                document.getElementById('language-dropdown')?.classList.add('hidden');
                document.getElementById('mobile-lang-menu')?.classList.add('hidden');
            });
        }
        
        // è®¾ç½®å›¾ç‰‡ä¸Šä¼ 
        function setupImageUpload() {
            document.getElementById('add-image-btn')?.addEventListener('click', function() {
                document.getElementById('image-upload')?.click();
            });
            
            document.getElementById('image-upload')?.addEventListener('change', handleImageUpload);
        }
        
        // è®¾ç½®è¯„è®ºæ¨¡æ€æ¡†
        function setupCommentModal() {
            document.getElementById('post-comment-btn')?.addEventListener('click', postComment);
            document.getElementById('close-comment-modal')?.addEventListener('click', function() {
                document.getElementById('comment-modal')?.classList.add('hidden');
            });
        }
        
        // è®¾ç½®åœ°å›¾åŠŸèƒ½
        function setupMapFunctions() {
            document.getElementById('add-marker-btn')?.addEventListener('click', function() {
                document.getElementById('add-marker-modal')?.classList.remove('hidden');
            });
            
            document.getElementById('close-marker-modal')?.addEventListener('click', function() {
                document.getElementById('add-marker-modal')?.classList.add('hidden');
                resetMarkerForm();
            });
            
            document.getElementById('submit-marker-btn')?.addEventListener('click', submitMarker);
            
            // æ ‡è®°ç…§ç‰‡ä¸Šä¼ 
            document.getElementById('marker-photo-upload-area')?.addEventListener('click', function() {
                document.getElementById('marker-photo-upload')?.click();
            });
            
            document.getElementById('marker-photo-upload')?.addEventListener('change', handleMarkerPhotoUpload);
            
            document.getElementById('remove-marker-photo')?.addEventListener('click', function() {
                document.getElementById('marker-photo-upload')?.value = '';
                document.getElementById('marker-photo-preview')?.classList.add('hidden');
            });
        }
        
        // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabId) {
            // è·å–æ‰€æœ‰æ ‡ç­¾å’Œå†…å®¹åŒºåŸŸ
            const tabs = ['message-tab', 'map-tab'];
            const contents = ['messages-content', 'map-content'];
            
            // é‡ç½®æ‰€æœ‰æ ‡ç­¾æ ·å¼
            tabs.forEach(id => {
                // è·å–æ‰€æœ‰åŒåæ ‡ç­¾ï¼ˆæ¡Œé¢å’Œç§»åŠ¨ï¼‰
                const tabElements = document.querySelectorAll(`[id="${id}"]`);
                tabElements.forEach(element => {
                    // æ ¹æ®å…ƒç´ ç±»å‹åº”ç”¨ä¸åŒçš„æ ·å¼
                    if (element.tagName === 'A') {
                        // å¯¹äºé“¾æ¥ç±»å‹çš„æ ‡ç­¾
                        element.classList.remove('text-primary', 'bg-primary/5', 'tab-active');
                        element.classList.add('text-gray-600');
                    } else {
                        // å¯¹äºæŒ‰é’®ç±»å‹çš„æ ‡ç­¾
                        element.classList.remove('text-primary', 'bg-primary/5', 'tab-active');
                        element.classList.add('text-gray-600');
                    }
                });
            });
            
            // éšè—æ‰€æœ‰å†…å®¹
            contents.forEach(id => {
                const content = document.getElementById(id);
                if (content) {
                    content.classList.add('hidden');
                }
            });
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            const activeTabElements = document.querySelectorAll(`[id="${tabId}"]`);
            activeTabElements.forEach(element => {
                if (element.tagName === 'A') {
                    element.classList.add('text-primary', 'bg-primary/5', 'tab-active');
                    element.classList.remove('text-gray-600');
                } else {
                    element.classList.add('text-primary', 'bg-primary/5', 'tab-active');
                    element.classList.remove('text-gray-600');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            const contentId = tabId === 'message-tab' ? 'messages-content' : 'map-content';
            const activeContent = document.getElementById(contentId);
            if (activeContent) {
                activeContent.classList.remove('hidden');
                activeContent.classList.add('animate-fade-in');
            }
            
            // ç‰¹æ®Šå¤„ç†åœ°å›¾æ ‡ç­¾
            if (tabId === 'map-tab') {
                const mapLoading = document.getElementById('map-loading');
                if (mapLoading) mapLoading.classList.remove('hidden');
                // åˆå§‹åŒ–åœ°å›¾ï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
                if (!window.mapInitialized) {
                    initializeMap();
                }
            }
        }
        
        // åˆ›å»ºæ˜Ÿæ˜ŸåŠ¨ç”»æ•ˆæœ
        function createStars() {
            const container = document.getElementById('stars-container');
            if (!container) return;
            
            const starCount = 50;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star-animation';
                
                // éšæœºä½ç½®å’Œå¤§å°
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 4 + 1}px`;
                star.style.height = star.style.width;
                star.style.opacity = Math.random() * 0.9 + 0.1;
                star.style.setProperty('--duration', `${Math.random() * 4 + 1}s`);
                star.style.animationDelay = `${Math.random() * 5}s`;
                
                // ä¸ºä¸€äº›æ˜Ÿæ˜Ÿæ·»åŠ é¢å¤–çš„å‘å…‰æ•ˆæœ
                if (Math.random() > 0.7) {
                    star.style.boxShadow = '0 0 8px rgba(255, 255, 255, 0.8)';
                }
                
                container.appendChild(star);
            }
        }

        function changeLanguage(lang) {
            if (!translations[lang]) return;
            
            // æ›´æ–°é¡µé¢ä¸Šæ‰€æœ‰å¸¦æœ‰data-lang-keyå±æ€§çš„å…ƒç´ 
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            
            let langText = 'ä¸­æ–‡';
            if (lang === 'en') {
                langText = 'English';
            } else if (lang === 'th') {
                langText = 'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢';
            }
            
            document.getElementById('current-language').textContent = langText;
            document.getElementById('language-dropdown').classList.add('hidden');
            document.getElementById('mobile-lang-menu').classList.add('hidden');
            
            // ä¿å­˜è¯­è¨€åå¥½åˆ°localStorage
            localStorage.setItem('preferredLanguage', lang);
            currentLang = lang;
        }

        // åˆå§‹åŒ–è¯­è¨€
        changeLanguage(currentLang);

        // è¯­è¨€åˆ‡æ¢äº‹ä»¶ç›‘å¬
        document.getElementById('language-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('language-dropdown').classList.toggle('hidden');
        });

        document.getElementById('mobile-lang-btn').addEventListener('click', () => {
            document.getElementById('mobile-lang-menu').classList.toggle('hidden');
        });

        document.querySelectorAll('#language-dropdown a, #mobile-lang-menu a').forEach(option => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                const lang = option.getAttribute('data-lang');
                changeLanguage(lang);
            });
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', () => {
            document.getElementById('language-dropdown').classList.add('hidden');
            document.getElementById('mobile-lang-menu').classList.add('hidden');
        });

        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        // é€€å‡ºç™»å½•åŠŸèƒ½
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm(translations[currentLang]['logout-confirm'])) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                alert(translations[currentLang]['logout-success']);
                window.location.href = 'login.html';
            }
        });

        // ç»Ÿä¸€æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabId) {
            // è·å–æ‰€æœ‰æ ‡ç­¾å’Œå†…å®¹åŒºåŸŸ
            const tabs = ['message-tab', 'map-tab'];
            const contents = ['messages-content', 'map-content'];
            
            // é‡ç½®æ‰€æœ‰æ ‡ç­¾æ ·å¼
            tabs.forEach(id => {
                // è·å–æ‰€æœ‰åŒåæ ‡ç­¾ï¼ˆæ¡Œé¢å’Œç§»åŠ¨ï¼‰
                const tabElements = document.querySelectorAll(`[id="${id}"]`);
                tabElements.forEach(element => {
                    // æ ¹æ®å…ƒç´ ç±»å‹åº”ç”¨ä¸åŒçš„æ ·å¼
                    if (element.tagName === 'A') {
                        // å¯¹äºé“¾æ¥ç±»å‹çš„æ ‡ç­¾
                        element.classList.remove('text-primary', 'bg-primary/5', 'tab-active');
                        element.classList.add('text-gray-600');
                    } else {
                        // å¯¹äºæŒ‰é’®ç±»å‹çš„æ ‡ç­¾
                        element.classList.remove('text-primary', 'bg-primary/5', 'tab-active');
                        element.classList.add('text-gray-600');
                    }
                });
            });
            
            // éšè—æ‰€æœ‰å†…å®¹
            contents.forEach(id => {
                const content = document.getElementById(id);
                if (content) {
                    content.classList.add('hidden');
                }
            });
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            const activeTabElements = document.querySelectorAll(`[id="${tabId}"]`);
            activeTabElements.forEach(element => {
                if (element.tagName === 'A') {
                    element.classList.add('text-primary', 'bg-primary/5', 'tab-active');
                    element.classList.remove('text-gray-600');
                } else {
                    element.classList.add('text-primary', 'bg-primary/5', 'tab-active');
                    element.classList.remove('text-gray-600');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            const contentId = tabId === 'message-tab' ? 'messages-content' : 'map-content';
            const activeContent = document.getElementById(contentId);
            if (activeContent) {
                activeContent.classList.remove('hidden');
                activeContent.classList.add('animate-fade-in');
            }
            
            // ç‰¹æ®Šå¤„ç†åœ°å›¾æ ‡ç­¾
            if (tabId === 'map-tab') {
                const mapLoading = document.getElementById('map-loading');
                if (mapLoading) mapLoading.classList.remove('hidden');
                // åˆå§‹åŒ–åœ°å›¾ï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
                if (!window.mapInitialized) {
                    initializeMap();
                }
            }
        }
        
        // æ·»åŠ æ ‡ç­¾ç‚¹å‡»äº‹ä»¶ç›‘å¬
        document.querySelectorAll('[id="message-tab"]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab('message-tab');
            });
        });
        
        document.querySelectorAll('[id="map-tab"]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab('map-tab');
            });
        });

        // ç²‰ä¸ç•™è¨€å¢™åŠŸèƒ½
        const messagesKey = 'fanMessages';
        const commentsKey = 'messageComments';
        
        // å½“å‰æ’åºæ–¹å¼
        let currentSort = 'latest';
        let currentSearch = '';

        // è·å–ä¿å­˜çš„ç•™è¨€æ•°æ®
        function getMessages() {
            const messages = localStorage.getItem(messagesKey);
            return messages ? JSON.parse(messages) : [];
        }

        // ä¿å­˜ç•™è¨€æ•°æ®
        function saveMessages(messages) {
            localStorage.setItem(messagesKey, JSON.stringify(messages));
            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
            renderMessages();
        }
        
        // æ’åºæ¶ˆæ¯
        function sortMessages(messages) {
            const sortedMessages = [...messages];
            
            switch(currentSort) {
                case 'popular':
                    return sortedMessages.sort((a, b) => {
                        const likesA = a.likes || 0;
                        const likesB = b.likes || 0;
                        return likesB - likesA;
                    });
                case 'mostComments':
                    return sortedMessages.sort((a, b) => {
                        const commentsA = getCommentsForMessage(a.id).length;
                        const commentsB = getCommentsForMessage(b.id).length;
                        return commentsB - commentsA;
                    });
                case 'latest':
                default:
                    return sortedMessages.sort((a, b) => {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
            }
        }
        
        // è¿‡æ»¤æ¶ˆæ¯
        function filterMessages(messages) {
            if (!currentSearch) return messages;
            
            const searchTerm = currentSearch.toLowerCase();
            return messages.filter(message => {
                return message.content.toLowerCase().includes(searchTerm) ||
                       message.username.toLowerCase().includes(searchTerm);
            });
        }
        
        // è®¾ç½®æ’åº
        function setSort(sortType) {
            currentSort = sortType;
            
            // æ›´æ–°æ’åºæŒ‰é’®æ ·å¼
            document.querySelectorAll('[data-sort]').forEach(btn => {
                if (btn.dataset.sort === sortType) {
                    btn.classList.add('text-primary', 'bg-primary/5');
                    btn.classList.remove('text-gray-600', 'hover:text-primary', 'hover:bg-primary/5');
                } else {
                    btn.classList.remove('text-primary', 'bg-primary/5');
                    btn.classList.add('text-gray-600', 'hover:text-primary', 'hover:bg-primary/5');
                }
            });
            
            // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
            renderMessages();
        }
        
        // è®¾ç½®æœç´¢
        function setSearch(searchTerm) {
            currentSearch = searchTerm;
            renderMessages();
        }

        // è·å–ä¿å­˜çš„è¯„è®ºæ•°æ®
        function getComments() {
            const comments = localStorage.getItem(commentsKey);
            return comments ? JSON.parse(comments) : {};
        }

        // ä¿å­˜è¯„è®ºæ•°æ®
        function saveComments(comments) {
            localStorage.setItem(commentsKey, JSON.stringify(comments));
        }

        // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
        function renderMessages() {
            const messagesList = document.getElementById('messages-list');
            const messagesLoading = document.getElementById('messages-loading');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (messagesLoading) messagesLoading.classList.remove('hidden');
            
            // è·å–ç•™è¨€æ•°æ®
            const allMessages = getMessages();
            
            // è¿‡æ»¤å’Œæ’åº
            const filteredMessages = filterMessages(allMessages);
            const sortedMessages = sortMessages(filteredMessages);
            
            messagesList.innerHTML = '';
            
            // éšè—åŠ è½½çŠ¶æ€
            if (messagesLoading) messagesLoading.classList.add('hidden');
            
            if (sortedMessages.length === 0) {
                messagesList.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-2xl">
                        <i class="fa fa-comments-o text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">${currentSearch ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç•™è¨€' : 'æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡ç•™è¨€å§ï¼'}</p>
                    </div>
                `;
                return;
            }

            // æ¸²æŸ“æ’åºåçš„æ¶ˆæ¯
            sortedMessages.forEach(message => {
                const isLiked = message.likes && message.likes.includes(currentUser.username);
                const likesCount = message.likes ? message.likes.length : 0;
                const comments = getComments()[message.id] || [];
                
                const messageCard = document.createElement('div');
                messageCard.className = 'bg-white rounded-2xl shadow-md p-6 message-card transition-custom';
                messageCard.setAttribute('data-message-id', message.id);
                
                messageCard.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mr-4">
                            <i class="fa fa-user text-primary text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${message.username}</h4>
                                    <p class="text-gray-500 text-sm">${formatDate(message.timestamp)}</p>
                                </div>
                            </div>
                            <p class="mt-2 text-gray-700">${escapeHTML(message.content)}</p>
                            ${message.images && message.images.length > 0 ? `
                                <div class="mt-3 grid grid-cols-2 gap-2">
                                    ${message.images.map(img => `
                                        <img src="${img}" alt="ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡" class="w-full h-32 object-cover rounded-lg">
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="mt-4 flex items-center space-x-6">
                                <button class="like-btn flex items-center text-gray-500 hover:text-primary transition-custom ${isLiked ? 'text-primary' : ''}">
                                    <i class="fa fa-heart mr-2"></i>
                                    <span>${likesCount}</span>
                                </button>
                                <button class="comment-btn flex items-center text-gray-500 hover:text-primary transition-custom">
                                    <i class="fa fa-comment mr-2"></i>
                                    <span>${comments.length}</span>
                                </button>
                            </div>
                            ${comments.length > 0 ? `
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <div class="space-y-3">
                                        ${comments.slice(0, 2).map(comment => `
                                            <div class="flex items-start">
                                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-2 flex-shrink-0">
                                                    <i class="fa fa-user text-gray-400"></i>
                                                </div>
                                                <div class="flex-1">
                                                    <div class="flex justify-between">
                                                        <p class="font-medium text-gray-900 text-sm">${comment.username}</p>
                                                        <p class="text-gray-400 text-xs">${formatDate(comment.timestamp)}</p>
                                                    </div>
                                                    <p class="text-gray-600 text-sm">${escapeHTML(comment.content)}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${comments.length > 2 ? `
                                        <button class="view-all-comments text-primary hover:text-primary/80 text-sm mt-2">
                                            <span data-lang-key="view-all">æŸ¥çœ‹å…¨éƒ¨</span> ${comments.length} <span data-lang-key="comments">è¯„è®º</span>
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                messagesList.appendChild(messageCard);
            });

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            addMessageEventListeners();
        }, 500); // 500mså»¶è¿Ÿï¼Œæ¨¡æ‹Ÿç½‘ç»œåŠ è½½

        // æ·»åŠ æ’åºå’Œæœç´¢äº‹ä»¶ç›‘å¬å™¨
        function addSortAndSearchListeners() {
            // æ·»åŠ æ’åºæŒ‰é’®äº‹ä»¶ç›‘å¬
            document.querySelectorAll('[data-sort]').forEach(btn => {
                btn.addEventListener('click', () => {
                    setSort(btn.dataset.sort);
                });
            });
            
            // æ·»åŠ æœç´¢äº‹ä»¶ç›‘å¬
            const searchInput = document.getElementById('message-search');
            if (searchInput) {
                // é˜²æŠ–æœç´¢
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        setSearch(e.target.value);
                    }, 300);
                });
            }
        }
        
        // æ·»åŠ ç•™è¨€äº‹ä»¶ç›‘å¬å™¨
        function addMessageEventListeners() {
            // ç‚¹èµæŒ‰é’®
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const messageId = this.closest('.message-card').getAttribute('data-message-id');
                    toggleLike(messageId, this);
                });
            });

            // è¯„è®ºæŒ‰é’®å’ŒæŸ¥çœ‹å…¨éƒ¨è¯„è®º
            document.querySelectorAll('.comment-btn, .view-all-comments').forEach(btn => {
                btn.addEventListener('click', function() {
                    const messageId = this.closest('.message-card').getAttribute('data-message-id');
                    openCommentModal(messageId);
                });
            });
        }

        // åˆ‡æ¢ç‚¹èµçŠ¶æ€
        function toggleLike(messageId, button) {
            const messages = getMessages();
            const message = messages.find(m => m.id === messageId);
            
            if (!message.likes) {
                message.likes = [];
            }
            
            const likeIndex = message.likes.indexOf(currentUser.username);
            if (likeIndex > -1) {
                // å–æ¶ˆç‚¹èµ
                message.likes.splice(likeIndex, 1);
                button.classList.remove('text-primary');
            } else {
                // æ·»åŠ ç‚¹èµ
                message.likes.push(currentUser.username);
                button.classList.add('text-primary');
            }
            
            saveMessages(messages);
            button.querySelector('span').textContent = message.likes.length;
        }

        // æ‰“å¼€è¯„è®ºæ¨¡æ€æ¡†
        function openCommentModal(messageId) {
            const messageCard = document.querySelector(`.message-card[data-message-id="${messageId}"]`);
            const username = messageCard.querySelector('h4').textContent;
            const comments = getComments()[messageId] || [];
            const commentsList = document.getElementById('comments-list');
            
            // ä¿å­˜å½“å‰æ¶ˆæ¯ID
            commentsList.setAttribute('data-message-id', messageId);
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-comment-o text-2xl mb-2"></i>
                        <p data-lang-key="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
                    </div>
                `;
            } else {
                commentsList.innerHTML = '';
                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'flex items-start';
                    commentEl.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fa fa-user text-gray-400"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <p class="font-medium text-gray-900">${comment.username}</p>
                                <p class="text-gray-400 text-sm">${formatDate(comment.timestamp)}</p>
                            </div>
                            <p class="text-gray-600">${escapeHTML(comment.content)}</p>
                        </div>
                    `;
                    commentsList.appendChild(commentEl);
                });
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('comment-modal').classList.remove('hidden');
        }

        // å‘å¸ƒè¯„è®º
        document.getElementById('post-comment-btn').addEventListener('click', function() {
            const messageId = document.getElementById('comments-list').getAttribute('data-message-id');
            const commentInput = document.getElementById('comment-input');
            const content = commentInput.value.trim();
            
            if (!content) return;
            
            // è·å–ç°æœ‰è¯„è®º
            const comments = getComments();
            if (!comments[messageId]) {
                comments[messageId] = [];
            }
            
            // æ·»åŠ æ–°è¯„è®º
            comments[messageId].push({
                id: Date.now().toString(),
                username: currentUser.username,
                content: content,
                timestamp: new Date().toISOString()
            });
            
            // ä¿å­˜è¯„è®º
            saveComments(comments);
            
            // æ›´æ–°UI
            commentInput.value = '';
            renderMessages(); // é‡æ–°æ¸²æŸ“ç•™è¨€åˆ—è¡¨ä»¥æ›´æ–°è¯„è®ºæ•°
            openCommentModal(messageId); // é‡æ–°æ‰“å¼€è¯„è®ºæ¨¡æ€æ¡†ä»¥æ˜¾ç¤ºæ–°è¯„è®º
            
            alert(translations[currentLang]['comment-posted']);
        });

        // å…³é—­è¯„è®ºæ¨¡æ€æ¡†
        document.getElementById('close-comment-modal').addEventListener('click', function() {
            document.getElementById('comment-modal').classList.add('hidden');
        });

        // å‘å¸ƒç•™è¨€
        document.getElementById('post-message-btn').addEventListener('click', function() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content) {
                // æ·»åŠ é”™è¯¯æç¤º
                messageInput.classList.add('border-red-500');
                setTimeout(() => {
                    messageInput.classList.remove('border-red-500');
                }, 2000);
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> å‘å¸ƒä¸­...';
            
            // è·å–é¢„è§ˆå›¾ç‰‡
            const imagePreviews = document.querySelectorAll('#image-preview-container img');
            const images = Array.from(imagePreviews).map(img => img.src);
            
            // è·å–ç°æœ‰ç•™è¨€
            const messages = getMessages();
            
            // æ·»åŠ æ–°ç•™è¨€
            messages.push({
                id: Date.now().toString(),
                username: currentUser.username,
                content: content,
                images: images,
                likes: [],
                timestamp: new Date().toISOString()
            });
            
            // ä¿å­˜ç•™è¨€
            saveMessages(messages); // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ä¿å­˜å‡½æ•°
            
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            setTimeout(() => {
                // æ›´æ–°UI
                messageInput.value = '';
                document.getElementById('image-preview-container').innerHTML = '';
                document.getElementById('image-preview-container').classList.add('hidden');
                renderMessages();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showNotification(translations[currentLang]['message-posted'], 'success');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                btn.innerHTML = originalText;
            }, 800);
        });

        // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
        document.getElementById('add-image-btn').addEventListener('click', function() {
            document.getElementById('image-upload').click();
        });

        document.getElementById('image-upload').addEventListener('change', function(e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('image-preview-container');
            
            previewContainer.classList.remove('hidden');
            
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'relative';
                        imgContainer.innerHTML = `
                            <img src="${event.target.result}" alt="é¢„è§ˆ" class="w-full h-32 object-cover rounded-lg">
                            <button class="absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center remove-image">
                                <i class="fa fa-times text-xs"></i>
                            </button>
                        `;
                        previewContainer.appendChild(imgContainer);
                        
                        // æ·»åŠ ç§»é™¤æŒ‰é’®äº‹ä»¶
                        imgContainer.querySelector('.remove-image').addEventListener('click', function() {
                            imgContainer.remove();
                            if (previewContainer.children.length === 0) {
                                previewContainer.classList.add('hidden');
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
            this.value = '';
        });

        // ä½¿ç”¨æ¨¡å—åŒ–çš„æ˜Ÿå…‰åœ°å›¾åŠŸèƒ½
        // æ˜¾ç¤ºé€šçŸ¥çš„è¾…åŠ©å‡½æ•°
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-20 opacity-0 z-50`;
            
            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            let bgColor, textColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-primary';
                    textColor = 'text-white';
                    icon = 'fa-info-circle';
            }
            
            notification.classList.add(...bgColor.split(' '), ...textColor.split(' '));
            
            // è®¾ç½®é€šçŸ¥å†…å®¹
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fa ${icon} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // 3ç§’åéšè—
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // åˆå§‹åŒ–æ˜Ÿå…‰åœ°å›¾
        async function initStarMap() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const mapLoading = document.getElementById('map-loading');
                if (mapLoading) mapLoading.classList.remove('hidden');
                
                // åˆå§‹åŒ–åœ°å›¾
                const map = await window.starMap.initializeMap('map', {
                    accessToken: 'pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2wxeXpldGhtMDNvNjNqcW1iNjc5OGZrbSJ9.2X83XK9Vf5gO9jK9qDcQIw', // ç¤ºä¾‹å¯†é’¥
                    style: 'mapbox://styles/mapbox/light-v10',
                    center: [105.8412, 21.0285], // åŒ—äº¬ä½œä¸ºé»˜è®¤ä¸­å¿ƒ
                    zoom: 3,
                    // æ·»åŠ æ˜Ÿç©ºèƒŒæ™¯æ•ˆæœ
                    enableStarBackground: true
                });
                
                // æ·»åŠ ç¤ºä¾‹æ ‡è®°æ•°æ®ï¼ˆä»…åœ¨æ²¡æœ‰æ ‡è®°æ—¶ï¼‰
                window.starMap.addExampleMarkers();
                
                // åŠ è½½æ ‡è®°
                window.starMap.loadMarkers(currentUser, showNotification);
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                window.starMap.updateMapStats();
                
                // æ›´æ–°ç»Ÿè®¡æ•°å­—åŠ¨ç”»
                const stats = window.starMap.getStats();
                window.starMap.animateNumber(document.getElementById('total-fans'), 0, stats.totalUsers || 15234);
                window.starMap.animateNumber(document.getElementById('total-markers'), 0, stats.totalMarkers || 8765);
                window.starMap.animateNumber(document.getElementById('total-cities'), 0, stats.totalCities || 234);
                window.starMap.animateNumber(document.getElementById('total-countries'), 0, stats.totalCountries || 45);
                
                // éšè—åŠ è½½çŠ¶æ€
                if (mapLoading) {
                    mapLoading.style.opacity = '0';
                    setTimeout(() => {
                        mapLoading.classList.add('hidden');
                    }, 500);
                }
                
                // åœ°å›¾åŠ è½½å®ŒæˆåŠ¨ç”»
                const mapContainer = document.getElementById('map');
                mapContainer.style.opacity = '0';
                mapContainer.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    mapContainer.style.opacity = '1';
                }, 100);
                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                const mapLoading = document.getElementById('map-loading');
                if (mapLoading) {
                    mapLoading.innerHTML = `
                        <i class="fa fa-exclamation-circle text-red-500 text-4xl mb-2"></i>
                        <p class="text-gray-600" data-lang-key="map-error">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                        <p class="text-sm text-gray-500 mt-2">é”™è¯¯è¯¦æƒ…: ${error.message}</p>
                    `;
                }
            }
        }

        // æ‰“å¼€æ·»åŠ æ ‡è®°æ¨¡æ€æ¡†
        document.getElementById('add-marker-btn').addEventListener('click', function() {
            const modal = document.getElementById('add-marker-modal');
            const modalContent = modal.querySelector('.scale-95');
            
            modal.classList.remove('hidden');
            // è§¦å‘é‡æ’ï¼Œç¡®ä¿åŠ¨ç”»ç”Ÿæ•ˆ
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        });

        // å…³é—­æ·»åŠ æ ‡è®°æ¨¡æ€æ¡†
        document.getElementById('close-marker-modal').addEventListener('click', function() {
            closeMarkerModal();
        });
        
        function closeMarkerModal() {
            const modal = document.getElementById('add-marker-modal');
            const modalContent = modal.querySelector('.scale-95');
            
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    resetMarkerForm();
                }, 300);
            }, 10);
        }

        // é‡ç½®æ ‡è®°è¡¨å•
        function resetMarkerForm() {
            document.getElementById('marker-city').value = '';
            document.getElementById('marker-message').value = '';
            document.getElementById('marker-photo-upload').value = '';
            document.getElementById('marker-photo-preview').classList.add('hidden');
        }

        // æ ‡è®°ç…§ç‰‡ä¸Šä¼ é¢„è§ˆ
        document.getElementById('marker-photo-upload-area').addEventListener('click', function() {
            document.getElementById('marker-photo-upload').click();
        });

        document.getElementById('marker-photo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ5MBé™åˆ¶ï¼‰
            if (file.size > 5 * 1024 * 1024) {
                showNotification(translations[currentLang]['file-too-large'] || 'ç…§ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                this.value = '';
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const validTypes = ['image/jpeg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showNotification(translations[currentLang]['invalid-file-type'] || 'è¯·ä¸Šä¼ JPGæˆ–PNGæ ¼å¼çš„å›¾ç‰‡', 'error');
                this.value = '';
                return;
            }
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('marker-preview-img').src = event.target.result;
                    document.getElementById('marker-photo-preview').classList.remove('hidden');
                    
                    // æ·»åŠ æ·¡å…¥åŠ¨ç”»
                    const preview = document.getElementById('marker-photo-preview');
                    preview.style.opacity = '0';
                    preview.style.transition = 'opacity 0.3s ease';
                    void preview.offsetWidth;
                    preview.style.opacity = '1';
                };
                reader.readAsDataURL(file);
            }
        }

        // ç§»é™¤æ ‡è®°ç…§ç‰‡
        document.getElementById('remove-marker-photo').addEventListener('click', function() {
            document.getElementById('marker-photo-upload').value = '';
            document.getElementById('marker-photo-preview').classList.add('hidden');
        });

        // æäº¤æ ‡è®°
        document.getElementById('submit-marker-btn').addEventListener('click', async function() {
            const city = document.getElementById('marker-city').value.trim();
            const message = document.getElementById('marker-message').value.trim();
            const previewImg = document.getElementById('marker-preview-img');
            const photo = previewImg.classList.contains('hidden') ? null : previewImg.src;
            const submitBtn = this;
            
            if (!city) {
                showNotification(translations[currentLang]['city-required'] || 'è¯·è¾“å…¥åŸå¸‚', 'error');
                return;
            }
            
            if (!message) {
                showNotification(translations[currentLang]['message-required'] || 'è¯·è¾“å…¥ç•™è¨€', 'error');
                return;
            }
            
            // ç¦ç”¨æäº¤æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            submitBtn.disabled = true;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> æäº¤ä¸­...';
            
            try {
                // æ¨¡æ‹Ÿåœ°ç†ä½ç½®ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨çœŸå®çš„åœ°ç†ä½ç½®APIï¼‰
                const lng = 73 + Math.random() * 50; // ä¸­å›½ç»åº¦èŒƒå›´
                const lat = 18 + Math.random() * 30; // ä¸­å›½çº¬åº¦èŒƒå›´
                
                // æ·»åŠ æ–°æ ‡è®°
                const newMarker = window.starMap.addMarker({
                    username: currentUser.username,
                    city: city,
                    message: message,
                    photo: photo,
                    lng: lng,
                    lat: lat,
                    timestamp: new Date().toISOString(),
                    likes: []
                });
                
                // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // æ›´æ–°åœ°å›¾
                const map = window.starMap.getMap();
                if (map) {
                    window.starMap.loadMarkers(currentUser, showNotification);
                    window.starMap.updateMapStats();
                    
                    // ç§»åŠ¨åˆ°æ–°æ ‡è®°ä½ç½®
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 8,
                        essential: true,
                        duration: 1500,
                        easing: function(t) { return t * (2 - t); }
                    });
                    
                    // åˆ›å»ºæ˜Ÿæ˜ŸåŠ¨ç”»æ•ˆæœ
                    createStarAnimation(map, lng, lat);
                }
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶é‡ç½®è¡¨å•
                closeMarkerModal();
                
                // æ›´æ–°ç»Ÿè®¡æ•°å­—
                const updatedStats = window.starMap.getStats();
                window.starMap.animateNumber(document.getElementById('total-markers'), parseInt(document.getElementById('total-markers').textContent.replace(/,/g, '')), updatedStats.totalMarkers);
                
                showNotification(translations[currentLang]['marker-added'] || 'æ ‡è®°æ·»åŠ æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('æäº¤æ ‡è®°å¤±è´¥:', error);
                showNotification(translations[currentLang]['marker-error'] || 'æ ‡è®°æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
        
        // æˆ‘çš„ä½ç½®æŒ‰é’®
        document.getElementById('my-location-btn').addEventListener('click', function() {
            const map = window.starMap.getMap();
            if (map) {
                // æ¨¡æ‹Ÿå®šä½åˆ°äºšæ´²åœ°åŒº
                map.easeTo({
                    center: [105.8412, 21.0285],
                    zoom: 4,
                    duration: 1500,
                    easing: function(t) {
                        return t * (2 - t);
                    }
                });
                
                showNotification(translations[currentLang]['located-asia'] || 'å·²å®šä½åˆ°äºšæ´²åŒºåŸŸ', 'info');
            }
        });
        
        // æ ‡å¿—ä½ï¼Œç¡®ä¿åœ°å›¾åªåˆå§‹åŒ–ä¸€æ¬¡
        let mapInitialized = false;
        
        // å®‰å…¨çš„åœ°å›¾åˆå§‹åŒ–å‡½æ•°
        function safelyInitMap() {
            if (!mapInitialized && window.starMap && typeof window.starMap.initializeMap === 'function') {
                console.log('åˆå§‹åŒ–æ˜Ÿå…‰åœ°å›¾...');
                mapInitialized = true;
                initStarMap().catch(error => {
                    console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                    showNotification('åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                    // æ˜¾ç¤ºåŠ è½½å¤±è´¥çŠ¶æ€
                    const loadingElement = document.getElementById('map-loading');
                    if (loadingElement) {
                        loadingElement.innerHTML = `
                            <div class="text-red-500 text-4xl mb-4">âš ï¸</div>
                            <p class="text-gray-600 mt-4 text-lg">åœ°å›¾åŠ è½½å¤±è´¥</p>
                            <button id="retry-map" class="mt-4 px-4 py-2 bg-primary text-white rounded-full hover:bg-primary/90">
                                é‡è¯•
                            </button>
                        `;
                        loadingElement.classList.remove('hidden');
                        // æ·»åŠ é‡è¯•æŒ‰é’®äº‹ä»¶
                        document.getElementById('retry-map').addEventListener('click', function() {
                            mapInitialized = false;
                            safelyInitMap();
                        });
                    }
                });
            }
        }
        
        // å½“map.jsæ¨¡å—åŠ è½½å®Œæˆååˆå§‹åŒ–åœ°å›¾
        window.addEventListener('starMapLoaded', function() {
            console.log('æ£€æµ‹åˆ°starMapLoadedäº‹ä»¶');
            safelyInitMap();
        });
        
        // å¦‚æœæ¨¡å—å·²ç»åŠ è½½ï¼Œåˆ™ç›´æ¥åˆå§‹åŒ–
        if (window.starMap) {
            console.log('æ£€æµ‹åˆ°starMapå¯¹è±¡å·²å­˜åœ¨');
            safelyInitMap();
        } else {
            console.warn('starMapå¯¹è±¡æœªæ‰¾åˆ°ï¼Œç­‰å¾…åŠ è½½...');
            // è®¾ç½®è¶…æ—¶æ£€æŸ¥
            setTimeout(() => {
                if (!window.starMap) {
                    console.error('è¶…æ—¶ï¼šæœªåŠ è½½starMapæ¨¡å—');
                    showNotification('åœ°å›¾æ¨¡å—åŠ è½½è¶…æ—¶', 'error');
                }
            }, 5000);
        }

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return translations[currentLang]['just-now'] || 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins} ${translations[currentLang]['minutes-ago'] || 'åˆ†é’Ÿå‰'}`;
            if (diffHours < 24) return `${diffHours} ${translations[currentLang]['hours-ago'] || 'å°æ—¶å‰'}`;
            if (diffDays < 30) return `${diffDays} ${translations[currentLang]['days-ago'] || 'å¤©å‰'}`;
            
            return date.toLocaleDateString(currentLang === 'zh' ? 'zh-CN' : currentLang === 'th' ? 'th-TH' : 'en-US');
        }

        // å·¥å…·å‡½æ•°ï¼šHTMLè½¬ä¹‰
        function escapeHTML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // åˆ›å»ºæ˜Ÿæ˜ŸåŠ¨ç”»æ•ˆæœ
        function createStars() {
            const container = document.getElementById('stars-container');
            if (!container) return;
            
            const starCount = 50; // å¢åŠ æ˜Ÿæ˜Ÿæ•°é‡
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star-animation';
                
                // éšæœºä½ç½®å’Œå¤§å°
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 4 + 1}px`; // å¢åŠ æœ€å¤§æ˜Ÿæ˜Ÿå¤§å°
                star.style.height = star.style.width;
                star.style.opacity = Math.random() * 0.9 + 0.1; // è°ƒæ•´é€æ˜åº¦èŒƒå›´
                star.style.setProperty('--duration', `${Math.random() * 4 + 1}s`); // è°ƒæ•´åŠ¨ç”»æŒç»­æ—¶é—´èŒƒå›´
                star.style.animationDelay = `${Math.random() * 5}s`;
                
                // ä¸ºä¸€äº›æ˜Ÿæ˜Ÿæ·»åŠ é¢å¤–çš„å‘å…‰æ•ˆæœ
                if (Math.random() > 0.7) {
                    star.style.boxShadow = '0 0 8px rgba(255, 255, 255, 0.8)';
                }
                
                container.appendChild(star);
            }
        }
        
        // åˆ›å»ºæ·»åŠ æ ‡è®°æ—¶çš„æ˜Ÿæ˜ŸåŠ¨ç”»
        function createStarAnimation(map, lng, lat) {
            if (!map) return;
            
            // è·å–åœ°å›¾å®¹å™¨
            const mapContainer = document.getElementById('map');
            
            // è½¬æ¢åœ°ç†åæ ‡ä¸ºå±å¹•åæ ‡
            const point = map.project([lng, lat]);
            
            // åˆ›å»ºæ˜Ÿæ˜Ÿå…ƒç´ 
            const star = document.createElement('div');
            star.className = 'star-animation';
            star.style.cssText = `
                position: absolute;
                left: ${point.x}px;
                top: ${point.y}px;
                width: 20px;
                height: 20px;
                background: rgba(255, 215, 0, 0.9);
                border-radius: 50%;
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
                transform: scale(0);
                pointer-events: none;
                z-index: 100;
            `;
            
            // æ·»åŠ åˆ°åœ°å›¾å®¹å™¨
            mapContainer.appendChild(star);
            
            // æ‰§è¡ŒåŠ¨ç”»
            setTimeout(() => {
                star.style.transition = 'all 1s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                star.style.transform = 'scale(2)';
                star.style.opacity = '0';
                star.style.boxShadow = '0 0 40px rgba(255, 215, 0, 0.5)';
                
                // åˆ›å»ºä¸€äº›å°çš„æ˜Ÿæ˜Ÿç²’å­
                for (let i = 0; i < 5; i++) {
                    const particle = document.createElement('div');
                    const angle = (i / 5) * Math.PI * 2;
                    const distance = 30;
                    const x = point.x + Math.cos(angle) * distance;
                    const y = point.y + Math.sin(angle) * distance;
                    
                    particle.style.cssText = `
                        position: absolute;
                        left: ${point.x}px;
                        top: ${point.y}px;
                        width: 8px;
                        height: 8px;
                        background: rgba(255, 255, 255, 0.9);
                        border-radius: 50%;
                        box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
                        opacity: 0;
                        pointer-events: none;
                        z-index: 100;
                    `;
                    
                    mapContainer.appendChild(particle);
                    
                    setTimeout(() => {
                        particle.style.transition = 'all 0.8s ease-out';
                        particle.style.left = `${x}px`;
                        particle.style.top = `${y}px`;
                        particle.style.opacity = '1';
                        
                        setTimeout(() => {
                            particle.style.opacity = '0';
                            setTimeout(() => {
                                if (mapContainer.contains(particle)) {
                                    particle.remove();
                                }
                            }, 800);
                        }, 400);
                    }, 10);
                }
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    if (mapContainer.contains(star)) {
                        star.remove();
                    }
                }, 1000);
            }, 10);
        }
        
        // æ˜¾ç¤ºé€šçŸ¥æç¤º
        function showNotification(message, type = 'success') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl flex items-center z-50 transform transition-all duration-300 ease-in-out translate-y-0 opacity-0`;
            
            // è®¾ç½®é€šçŸ¥ç±»å‹æ ·å¼
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
                notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i> ${message}`;
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
                notification.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> ${message}`;
            } else if (type === 'info') {
                notification.classList.add('bg-blue-500', 'text-white');
                notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i> ${message}`;
            }
            
            // æ·»åŠ åˆ°æ–‡æ¡£
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºé€šçŸ¥
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-0');
                notification.classList.add('translate-y-[-20px]', 'opacity-100');
            }, 10);
            
            // è‡ªåŠ¨å…³é—­
            setTimeout(() => {
                notification.classList.remove('translate-y-[-20px]', 'opacity-100');
                notification.classList.add('translate-y-0', 'opacity-0');
                // ç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // åˆå§‹åŒ–é¡µé¢
        function init() {
            // åˆ›å»ºæ˜Ÿæ˜ŸåŠ¨ç”»
            createStars();
            
            // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
            renderMessages();
            
            // æ·»åŠ æ’åºå’Œæœç´¢åŠŸèƒ½
            addSortAndSearchListeners();
            
            // åˆå§‹åŒ–ç¿»è¯‘
            changeLanguage(currentLang);
            
            // æ·»åŠ æ»šåŠ¨æ•ˆæœ - å¯¼èˆªæ æ ·å¼å˜åŒ–
            const navbar = document.getElementById('navbar');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    navbar.classList.add('shadow-md');
                    navbar.classList.remove('shadow-sm');
                } else {
                    navbar.classList.remove('shadow-md');
                    navbar.classList.add('shadow-sm');
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            init();
            // å»¶è¿Ÿåˆå§‹åŒ–ç¤¾åŒºåŠŸèƒ½å¢å¼ºæ¨¡å—ï¼Œç¡®ä¿åŸå§‹åŠŸèƒ½å·²åŠ è½½
            if (typeof initCommunityFeatures === 'function') {
                setTimeout(initCommunityFeatures, 1000);
            }
        });
    </script>
</body>
</html>